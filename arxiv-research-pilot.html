<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Arxiv Research Pilot</title>
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="An all-in-one research paper explorer, presenter, and AI assistant for researchers">
  <meta name="keywords" content="arxiv, research, papers, ai, machine learning, academic, pdf, text-to-speech">
  <meta name="author" content="Your Name">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#667eea">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Arxiv Research Pilot">
  
  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-180x180.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/icons/icon-167x167.png">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  
  <!-- Fonts and Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <!-- PDF.js for PDF processing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.worker.min.js';
  </script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      margin: 0;
      color: #222;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px 16px 64px 16px;
    }
    .header {
      text-align: center;
      color: #fff;
      margin-bottom: 32px;
    }
    .header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      letter-spacing: 1px;
    }
    .header .subtitle {
      font-size: 1.2rem;
      opacity: 0.9;
      margin-bottom: 0.5rem;
    }
    .main-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      min-height: 600px;
    }
    .left-panel {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.08);
    }
    .right-panel {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.08);
      min-height: 600px;
      display: flex;
      flex-direction: column;
    }
    
    /* Responsive design for mobile */
    @media (max-width: 1024px) {
      .main-layout {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      .right-panel {
        min-height: 400px;
      }
      .mode-selector {
        grid-template-columns: repeat(3, 1fr);
        gap: 0.3rem;
      }
      .mode-btn {
        font-size: 0.7rem;
        padding: 0.5rem 0.3rem;
        min-height: 60px;
      }
    }
    
    @media (max-width: 768px) {
      .mode-selector {
        grid-template-columns: repeat(2, 1fr);
      }
      .search-controls {
        flex-direction: column;
        gap: 1rem;
      }
      .input-group {
        min-width: 100%;
      }
    }
    
    .mode-selector {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 0.5rem;
      margin-bottom: 2rem;
      max-width: 100%;
    }
    .mode-btn {
      background: #fff;
      border: 2px solid #667eea;
      color: #667eea;
      border-radius: 8px;
      padding: 0.6rem 0.4rem;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.3rem;
      text-align: center;
      min-height: 70px;
      justify-content: center;
      word-wrap: break-word;
      line-height: 1.1;
    }
    .mode-btn.active, .mode-btn:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      border-color: #764ba2;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102,126,234,0.2);
    }
    .mode-btn i {
      font-size: 1.2rem;
      margin-bottom: 0.3rem;
    }
    
    /* Character highlighting animations */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.15); }
      100% { transform: scale(1.1); }
    }
    
    @keyframes glow {
      0% { box-shadow: 0 0 5px rgba(255, 235, 59, 0.5); }
      50% { box-shadow: 0 0 12px rgba(255, 235, 59, 0.8); }
      100% { box-shadow: 0 0 8px rgba(255, 235, 59, 0.7); }
    }
    
    .search-section {
      background: transparent;
      border-radius: 0;
      padding: 0;
      margin-bottom: 1.5rem;
      box-shadow: none;
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      align-items: flex-end;
      justify-content: space-between;
    }
    .search-controls {
      display: flex;
      gap: 1.2rem;
      flex-wrap: wrap;
      align-items: flex-end;
    }
    .input-group {
      display: flex;
      flex-direction: column;
      min-width: 180px;
    }
    .input-group label {
      font-weight: 600;
      margin-bottom: 0.3rem;
      color: #555;
    }
    .form-control {
      padding: 10px 14px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.2s;
    }
    .form-control:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 2px rgba(102,126,234,0.08);
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 22px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: box-shadow 0.2s, transform 0.2s;
      box-shadow: 0 2px 8px rgba(102,126,234,0.08);
    }
    .btn-primary:hover {
      box-shadow: 0 6px 18px rgba(102,126,234,0.18);
      transform: translateY(-2px);
    }
    .btn-secondary {
      background: #fff;
      color: #667eea;
      border: 2px solid #667eea;
      border-radius: 8px;
      padding: 8px 20px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(102,126,234,0.1);
    }
    .btn-secondary:hover {
      background: #667eea;
      color: #fff;
      box-shadow: 0 4px 12px rgba(102,126,234,0.2);
      transform: translateY(-1px);
    }
    .results-section {
      background: transparent;
      border-radius: 0;
      padding: 0;
      margin-bottom: 0;
      box-shadow: none;
    }
    .papers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: 18px;
    }
    .paper-card {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 18px 18px 12px 18px;
      border: 2px solid #e9ecef;
      transition: all 0.2s;
      cursor: pointer;
      position: relative;
      min-height: 160px;
      box-shadow: 0 2px 8px rgba(102,126,234,0.04);
    }
    .paper-card.selected, .paper-card:hover {
      border-color: #667eea;
      background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
      box-shadow: 0 8px 20px rgba(102,126,234,0.10);
    }
    .paper-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      line-height: 1.4;
      word-break: break-word;
    }
    .paper-authors {
      color: #666;
      font-size: 0.95rem;
      margin-bottom: 8px;
      font-style: italic;
      word-break: break-word;
    }
    .paper-summary {
      color: #555;
      font-size: 0.97rem;
      line-height: 1.5;
      margin-bottom: 10px;
      word-break: break-word;
    }
    .paper-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
      color: #888;
      gap: 10px;
    }
    .paper-date {
      background: #e8f5e8;
      color: #2e7d32;
      padding: 3px 8px;
      border-radius: 6px;
      font-weight: 600;
      white-space: nowrap;
    }
    .paper-link {
      color: #667eea;
      text-decoration: none;
      font-weight: 600;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .paper-link:hover {
      text-decoration: underline;
    }
    .mode-content {
      margin-top: 2rem;
      min-height: 300px;
    }
    .section-title {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: #667eea;
    }
    .section-box {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border-left: 4px solid #667eea;
      font-size: 1.08rem;
      line-height: 1.7;
      color: #222;
      word-break: break-word;
    }
    .blackboard {
      background: #222;
      color: #fff;
      font-family: 'Courier New', monospace;
      border-radius: 10px;
      padding: 2rem;
      min-height: 220px;
      font-size: 1.15rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
      position: relative;
    }
    .highlight {
      background: #ffd700;
      color: #222;
      padding: 0.2em 0.4em;
      border-radius: 4px;
      font-weight: 600;
    }
    .download-section {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border: 2px dashed #667eea;
      color: #333;
    }
    .ai-app-section {
      background: #fffbe7;
      border-radius: 10px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border-left: 4px solid #ffd700;
      color: #333;
    }
    .ai-bot {
      background: #222;
      color: #ffd700;
      border-radius: 8px;
      padding: 1rem;
      font-family: 'Courier New', monospace;
      margin-top: 1rem;
      min-height: 80px;
    }
    @media (max-width: 900px) {
      .mode-selector {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.8rem;
      }
      .mode-btn {
        font-size: 0.9rem;
        padding: 0.8rem 0.6rem;
        min-height: 70px;
      }
    }
    @media (max-width: 600px) {
      .mode-selector {
        grid-template-columns: 1fr;
        gap: 0.6rem;
      }
      .mode-btn {
        flex-direction: row;
        justify-content: flex-start;
        text-align: left;
        padding: 0.8rem 1rem;
        min-height: auto;
      }
      .mode-btn i {
        margin-bottom: 0;
        margin-right: 0.8rem;
        font-size: 1.1rem;
      }
      .container { padding: 8px; }
      .search-section, .results-section { padding: 10px; }
      .papers-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1><i class="fas fa-rocket"></i> Arxiv Research Pilot</h1>
      <div class="subtitle">Your all-in-one research paper explorer, presenter, and AI assistant</div>
    </div>
    
    <div class="main-layout">
      <!-- Left Panel: Search and Papers -->
      <div class="left-panel">
        <div class="search-section">
          <div class="search-controls">
            <div class="input-group">
              <label for="category">Category</label>
              <select id="category" class="form-control">
                <!-- Computer Science -->
                <optgroup label="Computer Science">
                  <option value="cs.AI">AI (Artificial Intelligence)</option>
                  <option value="cs.AR">AR (Hardware Architecture)</option>
                  <option value="cs.CC">CC (Computational Complexity)</option>
                  <option value="cs.CE">CE (Computational Engineering)</option>
                  <option value="cs.CG">CG (Computational Geometry)</option>
                  <option value="cs.CL">CL (Computation and Language)</option>
                  <option value="cs.CR">CR (Cryptography and Security)</option>
                  <option value="cs.CV">CV (Computer Vision)</option>
                  <option value="cs.CY">CY (Computers and Society)</option>
                  <option value="cs.DB">DB (Databases)</option>
                  <option value="cs.DC">DC (Distributed Computing)</option>
                  <option value="cs.DL">DL (Digital Libraries)</option>
                  <option value="cs.DM">DM (Discrete Mathematics)</option>
                  <option value="cs.DS">DS (Data Structures)</option>
                  <option value="cs.ET">ET (Emerging Technologies)</option>
                  <option value="cs.FL">FL (Formal Languages)</option>
                  <option value="cs.GL">GL (General Literature)</option>
                  <option value="cs.GR">GR (Graphics)</option>
                  <option value="cs.GT">GT (Computer Science and Game Theory)</option>
                  <option value="cs.HC">HC (Human-Computer Interaction)</option>
                  <option value="cs.IR">IR (Information Retrieval)</option>
                  <option value="cs.IT">IT (Information Theory)</option>
                  <option value="cs.LG">LG (Machine Learning)</option>
                  <option value="cs.LO">LO (Logic in Computer Science)</option>
                  <option value="cs.MA">MA (Multiagent Systems)</option>
                  <option value="cs.MM">MM (Multimedia)</option>
                  <option value="cs.MS">MS (Mathematical Software)</option>
                  <option value="cs.NA">NA (Numerical Analysis)</option>
                  <option value="cs.NE">NE (Neural Computing)</option>
                  <option value="cs.NI">NI (Networking and Internet Architecture)</option>
                  <option value="cs.OH">OH (Other Computer Science)</option>
                  <option value="cs.OS">OS (Operating Systems)</option>
                  <option value="cs.PF">PF (Performance)</option>
                  <option value="cs.PL">PL (Programming Languages)</option>
                  <option value="cs.RO">RO (Robotics)</option>
                  <option value="cs.SC">SC (Symbolic Computation)</option>
                  <option value="cs.SD">SD (Sound</option>
                  <option value="cs.SE">SE (Software Engineering)</option>
                  <option value="cs.SI">SI (Social and Information Networks)</option>
                  <option value="cs.SY">SY (Systems and Control)</option>
                </optgroup>
                
                <!-- Mathematics -->
                <optgroup label="Mathematics">
                  <option value="math.AG">AG (Algebraic Geometry)</option>
                  <option value="math.AT">AT (Algebraic Topology)</option>
                  <option value="math.AP">AP (Analysis of PDEs)</option>
                  <option value="math.CT">CT (Category Theory)</option>
                  <option value="math.CA">CA (Classical Analysis)</option>
                  <option value="math.CO">CO (Combinatorics)</option>
                  <option value="math.AC">AC (Commutative Algebra)</option>
                  <option value="math.CV">CV (Complex Variables)</option>
                  <option value="math.DG">DG (Differential Geometry)</option>
                  <option value="math.DS">DS (Dynamical Systems)</option>
                  <option value="math.FA">FA (Functional Analysis)</option>
                  <option value="math.GM">GM (General Mathematics)</option>
                  <option value="math.GN">GN (General Topology)</option>
                  <option value="math.GT">GT (Geometric Topology)</option>
                  <option value="math.GR">GR (Group Theory)</option>
                  <option value="math.HO">HO (History and Overview)</option>
                  <option value="math.IT">IT (Information Theory)</option>
                  <option value="math.KT">KT (K-Theory)</option>
                  <option value="math.LO">LO (Logic)</option>
                  <option value="math.MP">MP (Mathematical Physics)</option>
                  <option value="math.MG">MG (Metric Geometry)</option>
                  <option value="math.NT">NT (Number Theory)</option>
                  <option value="math.NA">NA (Numerical Analysis)</option>
                  <option value="math.OA">OA (Operator Algebras)</option>
                  <option value="math.OC">OC (Optimization and Control)</option>
                  <option value="math.PR">PR (Probability)</option>
                  <option value="math.QA">QA (Quantum Algebra)</option>
                  <option value="math.RT">RT (Representation Theory)</option>
                  <option value="math.RA">RA (Rings and Algebras)</option>
                  <option value="math.SP">SP (Spectral Theory)</option>
                  <option value="math.ST">ST (Statistics Theory)</option>
                  <option value="math.SG">SG (Symplectic Geometry)</option>
                </optgroup>
                
                <!-- Physics -->
                <optgroup label="Physics">
                  <option value="physics.acc-ph">ACC-PH (Accelerator Physics)</option>
                  <option value="physics.ao-ph">AO-PH (Atmospheric and Oceanic Physics)</option>
                  <option value="physics.app-ph">APP-PH (Applied Physics)</option>
                  <option value="physics.atm-clus">ATM-CLUS (Atomic and Molecular Clusters)</option>
                  <option value="physics.atom-ph">ATOM-PH (Atomic Physics)</option>
                  <option value="physics.bio-ph">BIO-PH (Biological Physics)</option>
                  <option value="physics.chem-ph">CHEM-PH (Chemical Physics)</option>
                  <option value="physics.class-ph">CLASS-PH (Classical Physics)</option>
                  <option value="physics.comp-ph">COMP-PH (Computational Physics)</option>
                  <option value="physics.data-an">DATA-AN (Data Analysis)</option>
                  <option value="physics.ed-ph">ED-PH (Physics Education)</option>
                  <option value="physics.flu-dyn">FLU-DYN (Fluid Dynamics)</option>
                  <option value="physics.gen-ph">GEN-PH (General Physics)</option>
                  <option value="physics.geo-ph">GEO-PH (Geophysics)</option>
                  <option value="physics.hist-ph">HIST-PH (History of Physics)</option>
                  <option value="physics.ins-det">INS-DET (Instrumentation and Detectors)</option>
                  <option value="physics.med-ph">MED-PH (Medical Physics)</option>
                  <option value="physics.optics">OPTICS (Optics)</option>
                  <option value="physics.plasm-ph">PLASM-PH (Plasma Physics)</option>
                  <option value="physics.pop-ph">POP-PH (Popular Physics)</option>
                  <option value="physics.soc-ph">SOC-PH (Physics and Society)</option>
                  <option value="physics.space-ph">SPACE-PH (Space Physics)</option>
                </optgroup>
                
                <!-- Quantitative Biology -->
                <optgroup label="Quantitative Biology">
                  <option value="q-bio.BM">BM (Biomolecules)</option>
                  <option value="q-bio.CB">CB (Cell Behavior)</option>
                  <option value="q-bio.GN">GN (Genomics)</option>
                  <option value="q-bio.MN">MN (Molecular Networks)</option>
                  <option value="q-bio.NC">NC (Neurons and Cognition)</option>
                  <option value="q-bio.OT">OT (Other Quantitative Biology)</option>
                  <option value="q-bio.PE">PE (Populations and Evolution)</option>
                  <option value="q-bio.QM">QM (Quantitative Methods)</option>
                  <option value="q-bio.SC">SC (Subcellular Processes)</option>
                  <option value="q-bio.TO">TO (Tissues and Organs)</option>
                </optgroup>
                
                <!-- Quantitative Finance -->
                <optgroup label="Quantitative Finance">
                  <option value="q-fin.CP">CP (Computational Finance)</option>
                  <option value="q-fin.EC">EC (Economics)</option>
                  <option value="q-fin.GN">GN (General Finance)</option>
                  <option value="q-fin.MF">MF (Mathematical Finance)</option>
                  <option value="q-fin.PM">PM (Portfolio Management)</option>
                  <option value="q-fin.PR">PR (Pricing of Risk)</option>
                  <option value="q-fin.RM">RM (Risk Management)</option>
                  <option value="q-fin.ST">ST (Statistical Finance)</option>
                  <option value="q-fin.TR">TR (Trading and Market Microstructure)</option>
                </optgroup>
                
                <!-- Statistics -->
                <optgroup label="Statistics">
                  <option value="stat.AP">AP (Applications)</option>
                  <option value="stat.CO">CO (Computation)</option>
                  <option value="stat.ML">ML (Machine Learning)</option>
                  <option value="stat.ME">ME (Methodology)</option>
                  <option value="stat.OT">OT (Other Statistics)</option>
                  <option value="stat.TH">TH (Statistics Theory)</option>
                </optgroup>
                
                <!-- Electrical Engineering and Systems Science -->
                <optgroup label="Electrical Engineering and Systems Science">
                  <option value="eess.AS">AS (Audio and Speech Processing)</option>
                  <option value="eess.IV">IV (Image and Video Processing)</option>
                  <option value="eess.SP">SP (Signal Processing)</option>
                  <option value="eess.SY">SY (Systems and Control)</option>
                </optgroup>
                
                <!-- Economics -->
                <optgroup label="Economics">
                  <option value="econ.EM">EM (Econometrics)</option>
                  <option value="econ.GN">GN (General Economics)</option>
                  <option value="econ.TH">TH (Theoretical Economics)</option>
                </optgroup>
                
                <!-- Condensed Matter Physics -->
                <optgroup label="Condensed Matter Physics">
                  <option value="cond-mat.dis-nn">DIS-NN (Disordered Systems and Neural Networks)</option>
                  <option value="cond-mat.mes-hall">MES-HALL (Mesoscopic Systems and Quantum Hall Effect)</option>
                  <option value="cond-mat.mtrl-sci">MTRL-SCI (Materials Science)</option>
                  <option value="cond-mat.other">OTHER (Other Condensed Matter)</option>
                  <option value="cond-mat.quant-gas">QUANT-GAS (Quantum Gases)</option>
                  <option value="cond-mat.soft">SOFT (Soft Condensed Matter)</option>
                  <option value="cond-mat.stat-mech">STAT-MECH (Statistical Mechanics)</option>
                  <option value="cond-mat.str-el">STR-EL (Strongly Correlated Electrons)</option>
                  <option value="cond-mat.supr-con">SUPR-CON (Superconductivity)</option>
                </optgroup>
                
                <!-- High Energy Physics -->
                <optgroup label="High Energy Physics">
                  <option value="hep-ex">HEP-EX (High Energy Physics - Experiment)</option>
                  <option value="hep-lat">HEP-LAT (High Energy Physics - Lattice)</option>
                  <option value="hep-ph">HEP-PH (High Energy Physics - Phenomenology)</option>
                  <option value="hep-th">HEP-TH (High Energy Physics - Theory)</option>
                </optgroup>
                
                <!-- Astrophysics -->
                <optgroup label="Astrophysics">
                  <option value="astro-ph.CO">CO (Cosmology and Nongalactic Astrophysics)</option>
                  <option value="astro-ph.EP">EP (Earth and Planetary Astrophysics)</option>
                  <option value="astro-ph.GA">GA (Galaxy Astrophysics)</option>
                  <option value="astro-ph.HE">HE (High Energy Astrophysical Phenomena)</option>
                  <option value="astro-ph.IM">IM (Instrumentation and Methods for Astrophysics)</option>
                  <option value="astro-ph.SR">SR (Solar and Stellar Astrophysics)</option>
                </optgroup>
              </select>
            </div>
            <div class="input-group">
              <label for="startDate">Start Date</label>
              <input type="date" id="startDate" class="form-control">
            </div>
            <div class="input-group">
              <label for="endDate">End Date</label>
              <input type="date" id="endDate" class="form-control">
            </div>
            <button class="btn-primary" id="searchBtn"><i class="fas fa-search"></i> Search</button>
          </div>
        </div>
        
        <div class="results-section">
          <div class="papers-grid" id="papersGrid"></div>
        </div>
      </div>
      
      <!-- Right Panel: Mode Selector and Content -->
      <div class="right-panel">
        <div class="mode-selector" id="modeSelector">
          <button class="mode-btn active" data-mode="abstract"><i class="fas fa-book-open"></i> Read Abstract</button>
          <button class="mode-btn" data-mode="demystify"><i class="fas fa-lightbulb"></i> Demystification</button>
          <button class="mode-btn" data-mode="classroom"><i class="fas fa-chalkboard-teacher"></i> Classroom</button>
          <button class="mode-btn" data-mode="deepresearch"><i class="fas fa-brain"></i> Deep Research</button>
          <button class="mode-btn" data-mode="download"><i class="fas fa-download"></i> Download</button>
        </div>
        
        <div class="mode-content" id="modeContent">
          <div style="text-align: center; padding: 40px; color: #666;">
            <i class="fas fa-hand-pointer" style="font-size: 3rem; color: #ccc; margin-bottom: 20px;"></i>
            <h3>Select a Paper</h3>
            <p>Click on any paper card on the left to view it in Read Abstract mode.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    // Global variables
    let papersData = [];
    let selectedPaper = null;
    let currentMode = 'abstract';

    // DOM elements
    const elements = {
      category: document.getElementById('category'),
      startDate: document.getElementById('startDate'),
      endDate: document.getElementById('endDate'),
      searchBtn: document.getElementById('searchBtn'),
      papersGrid: document.getElementById('papersGrid'),
      modeContent: document.getElementById('modeContent'),
      modeSelector: document.getElementById('modeSelector')
    };

    // PWA Service Worker Registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => {
            console.log('SW registered: ', registration);
          })
          .catch(registrationError => {
            console.log('SW registration failed: ', registrationError);
          });
      });
    }

    // PWA Install Prompt
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      showInstallPrompt();
    });

    function showInstallPrompt() {
      const installBtn = document.createElement('div');
      installBtn.innerHTML = `
        <div style="position: fixed; top: 20px; right: 20px; background: #667eea; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; cursor: pointer; font-weight: 600;">
          <i class="fas fa-download"></i> Install App
        </div>
      `;
      installBtn.onclick = () => {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            console.log('User accepted the install prompt');
          }
          deferredPrompt = null;
          installBtn.remove();
        });
      };
      document.body.appendChild(installBtn);
    }

    // Mobile-specific optimizations
    function initMobileOptimizations() {
      // Prevent zoom on double tap
      let lastTouchEnd = 0;
      document.addEventListener('touchend', function (event) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
          event.preventDefault();
        }
        lastTouchEnd = now;
      }, false);

      // Add touch feedback
      document.querySelectorAll('.paper-card, .mode-btn, .btn-primary').forEach(element => {
        element.addEventListener('touchstart', function() {
          this.style.transform = 'scale(0.98)';
        });
        element.addEventListener('touchend', function() {
          this.style.transform = 'scale(1)';
        });
      });
    }

    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
      // Set default dates
      const today = new Date();
      const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
      elements.endDate.value = today.toISOString().split('T')[0];
      elements.startDate.value = thirtyDaysAgo.toISOString().split('T')[0];

      // Initialize mobile optimizations
      initMobileOptimizations();

      // Event listeners
      elements.searchBtn.addEventListener('click', searchPapers);
      elements.modeSelector.addEventListener('click', handleModeChange);

      // Check for URL parameters (for PWA shortcuts)
      const urlParams = new URLSearchParams(window.location.search);
      const mode = urlParams.get('mode');
      if (mode) {
        const modeBtn = document.querySelector(`[data-mode="${mode}"]`);
        if (modeBtn) {
          modeBtn.click();
        }
      }

      // Initial search
      searchPapers();
    });

    // Search papers - Updated to use server API
    async function searchPapers() {
      const category = elements.category.value;
      const startDate = elements.startDate.value;
      const endDate = elements.endDate.value;
      
      if (!category) {
        alert('Please select a category');
        return;
      }
      
      elements.searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Searching...';
      elements.searchBtn.disabled = true;
      
      try {
        const params = new URLSearchParams({
          category: category,
          ...(startDate && { startDate: startDate.replace(/-/g, '') }),
          ...(endDate && { endDate: endDate.replace(/-/g, '') })
        });
        
        const response = await fetch(`/api/papers?${params}`);
        const result = await response.json();
        
        if (result.success) {
          papersData = result.papers;
          displayPapers();
          updateModeContent();
        } else {
          throw new Error(result.error || 'Failed to fetch papers');
        }
        
      } catch (error) {
        console.error('Error fetching papers:', error);
        elements.papersGrid.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #666;">
            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ccc; margin-bottom: 20px;"></i>
            <h3>Error Loading Papers</h3>
            <p>${error.message}</p>
            <button class="btn-primary" onclick="searchPapers()">
              <i class="fas fa-refresh"></i> Try Again
            </button>
          </div>
        `;
      } finally {
        elements.searchBtn.innerHTML = '<i class="fas fa-search"></i> Search';
        elements.searchBtn.disabled = false;
      }
    }

    // Display papers in grid
    function displayPapers() {
      if (papersData.length === 0) {
        elements.papersGrid.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #666;">
            <i class="fas fa-search" style="font-size: 3rem; color: #ccc; margin-bottom: 20px;"></i>
            <h3>No papers found</h3>
            <p>Try adjusting your search criteria or date range.</p>
          </div>
        `;
        return;
      }

      const papersHTML = papersData.map((paper, index) => `
        <div class="paper-card" data-index="${index}" onclick="selectPaper(${index})">
          <div class="paper-title">${paper.title}</div>
          <div class="paper-authors">${paper.authors}</div>
          <div class="paper-summary">${paper.summary}</div>
          <div class="paper-meta">
            <span class="paper-date">${formatDate(paper.published)}</span>
            <a href="${paper.pdfUrl}" class="paper-link" onclick="event.stopPropagation()">
              <i class="fas fa-external-link-alt"></i> PDF
            </a>
          </div>
        </div>
      `).join('');

      elements.papersGrid.innerHTML = papersHTML;
    }

    // Select a paper - Server-side processing approach
    async function selectPaper(index) {
      // Remove previous selection
      document.querySelectorAll('.paper-card').forEach(card => {
        card.classList.remove('selected');
      });
      
      // Add selection to clicked card
      const selectedCard = document.querySelector(`[data-index="${index}"]`);
      if (selectedCard) {
        selectedCard.classList.add('selected');
      }
      
      selectedPaper = papersData[index];
      updateModeContent();
      
      // Start server-side content extraction
      elements.modeContent.innerHTML += `
        <div id="contentStatus" style="margin-top:1rem;color:#888;">
          <i class="fas fa-spinner fa-spin"></i> Processing paper content on server...
          <br><small style="color: #666;">Extracting and organizing content...</small>
        </div>
      `;
      
      try {
        const response = await fetch('/api/papers/extract', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ paper: selectedPaper })
        });
        
        const result = await response.json();
        
        if (result.success && result.content) {
          selectedPaper.fullText = result.content.fullText;
          selectedPaper.sections = result.content.sections;
          selectedPaper.wordCount = result.content.wordCount;
          selectedPaper.characterCount = result.content.characterCount;
          
          document.getElementById('contentStatus').innerHTML = `
            <div style="color: #28a745; font-weight: 600;">
              <i class="fas fa-check-circle"></i> Paper content processed successfully!
              <br><small style="color: #666;">
                ${result.content.wordCount} words, ${result.content.characterCount} characters, ${result.content.sections.length} sections
              </small>
            </div>
          `;
        } else {
          selectedPaper.fullText = null;
          document.getElementById('contentStatus').innerHTML = `
            <div style="color: #ffc107; font-weight: 600;">
              <i class="fas fa-exclamation-triangle"></i> Server processing failed. Using abstract only.
              <br><small style="color: #666;">Error: ${result.error || 'Unknown error'}</small>
            </div>
          `;
        }
        
        // Update the mode content to reflect the new data
        updateModeContent();
        
      } catch (err) {
        console.error('Server processing failed:', err);
        selectedPaper.fullText = null;
        document.getElementById('contentStatus').innerHTML = `
          <div style="color: #dc3545; font-weight: 600;">
            <i class="fas fa-times-circle"></i> Server processing failed. Using abstract only.
            <br><small style="color: #666;">Error: ${err.message}</small>
          </div>
        `;
        updateModeContent();
      }
    }

    // Handle mode change
    function handleModeChange(event) {
      if (event.target.classList.contains('mode-btn')) {
        // Update active button
        document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        // Update current mode
        currentMode = event.target.dataset.mode;
        updateModeContent();
      }
    }

    // Update mode content based on selected paper and mode
    function updateModeContent() {
      if (!selectedPaper) {
        elements.modeContent.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #666;">
            <i class="fas fa-hand-pointer" style="font-size: 3rem; color: #ccc; margin-bottom: 20px;"></i>
            <h3>Select a Paper</h3>
            <p>Click on any paper card on the left to view it in Read Abstract mode.</p>
          </div>
        `;
        return;
      }

      switch (currentMode) {
        case 'abstract':
          showAbstractMode();
          break;
        case 'demystify':
          showDemystifyMode();
          break;
        case 'classroom':
          showClassroomMode();
          break;
        case 'download':
          showDownloadMode();
          break;
        case 'deepresearch':
          showDeepResearchMode();
          break;
      }
    }

    // Research Paper Read Mode - Enhanced with server-processed content
    function showAbstractMode() {
      const hasFullText = selectedPaper.fullText && selectedPaper.fullText.length > 500;
      const displayText = hasFullText ? selectedPaper.fullText : selectedPaper.summary;
      
      elements.modeContent.innerHTML = `
        <div class="section-title">
          <i class="fas fa-book-open"></i> Research Paper Read Mode ${hasFullText ? '(Full Paper Content)' : '(Abstract Only)'}
        </div>
        <div class="section-box">
          <h3 style="margin-bottom: 1rem; color: #667eea;">${selectedPaper.title}</h3>
          <p style="margin-bottom: 1rem;"><strong>Authors:</strong> ${selectedPaper.authors}</p>
          <p style="margin-bottom: 1rem;"><strong>Published:</strong> ${formatDate(selectedPaper.published)}</p>
          ${hasFullText ? `
            <p style="margin-bottom: 1rem;"><strong>Content Stats:</strong> ${selectedPaper.wordCount} words, ${selectedPaper.characterCount} characters</p>
          ` : ''}
          <div style="margin-top: 1.5rem;">
            <h4 style="color: #667eea; margin-bottom: 0.5rem;">${hasFullText ? 'Full Paper Content:' : 'Abstract:'}</h4>
            <div style="line-height: 1.7; text-align: justify; max-height: 400px; overflow-y: auto; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
              ${displayText.replace(/\n/g, '<br>')}
            </div>
          </div>
        </div>
        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
          <button class="btn-primary" onclick="speakText('${displayText.replace(/'/g, "\\'")}')" id="speakBtn">
            <i class="fas fa-volume-up"></i> Listen to ${hasFullText ? 'Paper' : 'Abstract'}
          </button>
          <button class="btn-primary" onclick="stopSpeaking()" id="stopBtn" style="display: none;">
            <i class="fas fa-stop"></i> Stop
          </button>
          <button class="btn-primary" onclick="speakText('${selectedPaper.title.replace(/'/g, "\\'")}')" id="speakTitleBtn">
            <i class="fas fa-volume-up"></i> Listen to Title
          </button>
          <button class="btn-primary" onclick="stopSpeaking()" id="stopTitleBtn" style="display: none;">
            <i class="fas fa-stop"></i> Stop Title
          </button>
          <button class="btn-primary" onclick="window.location.href='${selectedPaper.pdfUrl}'">
            <i class="fas fa-file-pdf"></i> Open PDF
          </button>
          <button class="btn-primary" onclick="window.location.href='https://arxiv.org/html/${selectedPaper.id}'">
            <i class="fas fa-file-code"></i> Open HTML
          </button>
        </div>
      `;
    }

    // Classroom Mode - Enhanced with server-processed sections and PDF/HTML extraction
    async function showClassroomMode() {
      elements.modeContent.innerHTML = `
        <div class="section-title">
          <i class="fas fa-chalkboard-teacher"></i> Classroom Mode - Loading Enhanced Content...
        </div>
        <div class="section-box">
          <div style="text-align: center; padding: 2rem;">
            <div class="spinner" style="margin: 0 auto 1rem;"></div>
            <p>Extracting full paper content from PDF/HTML sources...</p>
          </div>
        </div>
      `;

      try {
        // Try to get enhanced content from server
        const response = await fetch('/api/extract-enhanced', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            paper: {
              ...selectedPaper,
              pdfUrl: selectedPaper.pdfUrl || `https://arxiv.org/pdf/${selectedPaper.id}.pdf`
            }
          })
        });

        const data = await response.json();
        
        if (data.success && data.content.sections && data.content.sections.length > 0 && data.content.wordCount > 100) {
          // Use enhanced content with full sections
          const sections = data.content.sections;
          let currentSection = 0;

          function renderClassroomSection() {
            const section = sections[currentSection];
            const sectionTitle = section.title;
            const sectionContent = section.content;
            
            elements.modeContent.innerHTML = `
              <div class="section-title">
                <i class="fas fa-chalkboard-teacher"></i> Classroom Mode (Full Paper Content)
              </div>
              <div class="blackboard">
                <div style="margin-bottom: 1rem; color: #ffd700;">
                  <strong>${sectionTitle} (${currentSection + 1} of ${sections.length})</strong>
                </div>
                <div id="animatedText" style="line-height: 1.6; max-height: 300px; overflow-y: auto;">${sectionContent}</div>
              </div>
              <div style="display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center;">
                <button class="btn-primary" ${currentSection === 0 ? 'disabled' : ''} onclick="changeClassroomSection(${currentSection - 1})">
                  <i class="fas fa-chevron-left"></i> Previous
                </button>
                <button class="btn-primary" onclick="speakClassroomSection()" id="speakClassroomBtn">
                  <i class="fas fa-volume-up"></i> Read Aloud
                </button>
                <button class="btn-primary" onclick="stopSpeaking()" id="stopClassroomBtn" style="display: none;">
                  <i class="fas fa-stop"></i> Stop
                </button>
                <button class="btn-primary" ${currentSection === sections.length - 1 ? 'disabled' : ''} onclick="changeClassroomSection(${currentSection + 1})">
                  Next <i class="fas fa-chevron-right"></i>
                </button>
              </div>
              <div style="margin-top: 1rem; text-align: center; color: #28a745; font-size: 0.9rem;">
                <i class="fas fa-check-circle"></i> Enhanced content loaded (${data.content.wordCount} words)
              </div>
            `;
            
            // Store current section content globally for audio function
            window.currentClassroomSection = {
              title: sectionTitle,
              content: sectionContent,
              sectionIndex: currentSection,
              totalSections: sections.length
            };
            
            animateText(sectionContent);
          }

          window.changeClassroomSection = function(newSection) {
            if (newSection >= 0 && newSection < sections.length) {
              currentSection = newSection;
              renderClassroomSection();
            }
          };

          renderClassroomSection();
        } else {
          // Fallback to original content - always works
          const hasFullText = selectedPaper.fullText && selectedPaper.fullText.length > 500;
          const sections = hasFullText && selectedPaper.sections ? selectedPaper.sections : splitIntoSection(selectedPaper.summary);
          
          let currentSection = 0;

          function renderClassroomSection() {
            const section = sections[currentSection];
            const sectionTitle = section.title;
            const sectionContent = section.content;
            
            elements.modeContent.innerHTML = `
              <div class="section-title">
                <i class="fas fa-chalkboard-teacher"></i> Classroom Mode ${hasFullText ? '(Full Paper)' : '(Abstract)'}
              </div>
              <div class="blackboard">
                <div style="margin-bottom: 1rem; color: #ffd700;">
                  <strong>${sectionTitle} (${currentSection + 1} of ${sections.length})</strong>
                </div>
                <div id="animatedText" style="line-height: 1.6; max-height: 300px; overflow-y: auto;">${sectionContent}</div>
              </div>
              <div style="display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center;">
                <button class="btn-primary" ${currentSection === 0 ? 'disabled' : ''} onclick="changeClassroomSection(${currentSection - 1})">
                  <i class="fas fa-chevron-left"></i> Previous
                </button>
                <button class="btn-primary" onclick="speakClassroomSection()" id="speakClassroomBtn">
                  <i class="fas fa-volume-up"></i> Read Aloud
                </button>
                <button class="btn-primary" onclick="stopSpeaking()" id="stopClassroomBtn" style="display: none;">
                  <i class="fas fa-stop"></i> Stop
                </button>
                <button class="btn-primary" ${currentSection === sections.length - 1 ? 'disabled' : ''} onclick="changeClassroomSection(${currentSection + 1})">
                  Next <i class="fas fa-chevron-right"></i>
                </button>
              </div>
              <div style="margin-top: 1rem; text-align: center; color: #ffc107; font-size: 0.9rem;">
                <i class="fas fa-exclamation-triangle"></i> Using available content (${sections.length} sections)
              </div>
            `;
            
            // Store current section content globally for audio function
            window.currentClassroomSection = {
              title: sectionTitle,
              content: sectionContent,
              sectionIndex: currentSection,
              totalSections: sections.length
            };
            
            animateText(sectionContent);
          }

          window.changeClassroomSection = function(newSection) {
            if (newSection >= 0 && newSection < sections.length) {
              currentSection = newSection;
              renderClassroomSection();
            }
          };

          renderClassroomSection();
        }
      } catch (error) {
        console.error('Error loading enhanced content:', error);
        // Fallback to original implementation - always works
        const hasFullText = selectedPaper.fullText && selectedPaper.fullText.length > 500;
        const sections = hasFullText && selectedPaper.sections ? selectedPaper.sections : splitIntoSection(selectedPaper.summary);
        
        let currentSection = 0;

        function renderClassroomSection() {
          const section = sections[currentSection];
          const sectionTitle = section.title;
          const sectionContent = section.content;
          
          elements.modeContent.innerHTML = `
            <div class="section-title">
              <i class="fas fa-chalkboard-teacher"></i> Classroom Mode ${hasFullText ? '(Full Paper)' : '(Abstract)'}
            </div>
            <div class="blackboard">
              <div style="margin-bottom: 1rem; color: #ffd700;">
                <strong>${sectionTitle} (${currentSection + 1} of ${sections.length})</strong>
              </div>
              <div id="animatedText" style="line-height: 1.6; max-height: 300px; overflow-y: auto;">${sectionContent}</div>
            </div>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center;">
              <button class="btn-primary" ${currentSection === 0 ? 'disabled' : ''} onclick="changeClassroomSection(${currentSection - 1})">
                <i class="fas fa-chevron-left"></i> Previous
              </button>
              <button class="btn-primary" onclick="speakClassroomSection()" id="speakClassroomBtn">
                <i class="fas fa-volume-up"></i> Read Aloud
              </button>
              <button class="btn-primary" onclick="stopSpeaking()" id="stopClassroomBtn" style="display: none;">
                <i class="fas fa-stop"></i> Stop
              </button>
              <button class="btn-primary" ${currentSection === sections.length - 1 ? 'disabled' : ''} onclick="changeClassroomSection(${currentSection + 1})">
                Next <i class="fas fa-chevron-right"></i>
              </button>
            </div>
            <div style="margin-top: 1rem; text-align: center; color: #ffc107; font-size: 0.9rem;">
              <i class="fas fa-exclamation-triangle"></i> Using available content (${sections.length} sections)
            </div>
          `;
          
          // Store current section content globally for audio function
          window.currentClassroomSection = {
            title: sectionTitle,
            content: sectionContent,
            sectionIndex: currentSection,
            totalSections: sections.length
          };
          
          animateText(sectionContent);
        }

        window.changeClassroomSection = function(newSection) {
          if (newSection >= 0 && newSection < sections.length) {
            currentSection = newSection;
            renderClassroomSection();
          }
        };

        renderClassroomSection();
      }
    }

    // Download Mode - Enhanced with server-processed content
    function showDownloadMode() {
      const hasFullText = selectedPaper.fullText && selectedPaper.fullText.length > 500;
      const sections = hasFullText && selectedPaper.sections ? selectedPaper.sections : splitIntoSection(selectedPaper.summary);
      
      elements.modeContent.innerHTML = `
        <div class="section-title">
          <i class="fas fa-download"></i> Download/Extract Mode ${hasFullText ? '(Full Paper)' : '(Abstract)'}
        </div>
        <div class="download-section">
          <h3 style="margin-bottom: 1rem;">${selectedPaper.title}</h3>
          <p style="margin-bottom: 1.5rem;"><strong>Authors:</strong> ${selectedPaper.authors}</p>
          <p style="margin-bottom: 1.5rem;"><strong>Published:</strong> ${formatDate(selectedPaper.published)}</p>
          ${hasFullText ? `
            <p style="margin-bottom: 1.5rem;"><strong>Content Stats:</strong> ${selectedPaper.wordCount} words, ${selectedPaper.characterCount} characters</p>
          ` : ''}
          
          <div style="margin: 1.5rem 0;">
            <h4 style="color: #667eea; margin-bottom: 1rem;">Quick Download Options:</h4>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
              <button class="btn-primary" onclick="window.location.href='${selectedPaper.pdfUrl}'">
                <i class="fas fa-file-pdf"></i> Open PDF
              </button>
              <button class="btn-primary" onclick="downloadPowerPoint()">
                <i class="fas fa-file-powerpoint"></i> PowerPoint Style
              </button>
              <button class="btn-primary" onclick="downloadFullText()">
                <i class="fas fa-file-text"></i> Download Full Text
              </button>
              <button class="btn-primary" onclick="downloadClassroomContent()">
                <i class="fas fa-chalkboard-teacher"></i> Download Classroom Content
              </button>
            </div>
          </div>

          <div style="margin: 1.5rem 0;">
            <h4 style="color: #667eea; margin-bottom: 1rem;">Select Sections to Download (${sections.length} total):</h4>
            <div style="margin-bottom: 1rem;">
              <button class="btn-secondary" onclick="selectAllSections()" style="margin-right: 0.5rem;">
                <i class="fas fa-check-square"></i> Select All
              </button>
              <button class="btn-secondary" onclick="deselectAllSections()" style="margin-right: 0.5rem;">
                <i class="fas fa-square"></i> Deselect All
              </button>
              <button class="btn-primary" onclick="downloadSelectedSections()">
                <i class="fas fa-download"></i> Download Selected Sections
              </button>
            </div>
            <div style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 300px; overflow-y: auto;">
              ${sections.map((section, index) => {
                const title = section.title;
                const content = section.content;
                return `
                  <label style="display: flex; align-items: flex-start; gap: 0.5rem; cursor: pointer; padding: 0.5rem; background: #f8f9fa; border-radius: 4px; transition: background-color 0.2s;">
                    <input type="checkbox" checked data-section-index="${index}" style="margin-top: 0.2rem;" onchange="updateSectionSelection()">
                    <div style="flex: 1;">
                      <strong style="font-size: 0.9rem;">${title}</strong>
                      <div style="font-size: 0.85rem; color: #666; margin-top: 0.2rem;">${content.substring(0, 150)}...</div>
                    </div>
                  </label>
                `;
              }).join('')}
            </div>
            <div id="selectionSummary" style="margin-top: 1rem; padding: 0.5rem; background: #e8f5e8; border-radius: 4px; font-size: 0.9rem;">
              <strong>Selected:</strong> ${sections.length} of ${sections.length} sections
            </div>
          </div>
          
          <div style="margin: 1.5rem 0;">
            <h4 style="color: #667eea; margin-bottom: 1rem;">Classroom Content Summary:</h4>
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; border-left: 4px solid #667eea;">
              <p style="margin-bottom: 0.5rem;"><strong>Total Sections:</strong> ${sections.length}</p>
              <p style="margin-bottom: 0.5rem;"><strong>Content Type:</strong> ${hasFullText ? 'Full Paper Content' : 'Abstract-Based Content'}</p>
              <p style="margin-bottom: 0.5rem;"><strong>Word Count:</strong> ${hasFullText ? selectedPaper.wordCount : 'Abstract only'}</p>
              <p style="margin-bottom: 0;"><strong>Format:</strong> Classroom-ready sections with titles and content</p>
            </div>
          </div>
        </div>
      `;
    }

    // Deep Research Mode - Enhanced with AI Research Assistant
    function showDeepResearchMode() {
      const hasFullText = selectedPaper.fullText && selectedPaper.fullText.length > 500;
      
      elements.modeContent.innerHTML = `
        <div class="section-title">
          <i class="fas fa-brain"></i> AI Research Assistant ${hasFullText ? '(Full Paper)' : '(Abstract)'}
        </div>
        
        <div class="research-studio">
          <!-- Left Panel: AI Research Tools -->
          <div class="studio-left-panel">
            <div class="panel-header">
              <h3><i class="fas fa-robot"></i> AI Research Tools</h3>
              <p class="paper-title">${selectedPaper.title}</p>
            </div>
            
            <!-- Mathematical Models Section -->
            <div class="ai-tool-section">
              <h4><i class="fas fa-square-root-alt"></i> Mathematical Models</h4>
              <div class="tool-description">
                Extract mathematical models, equations, and algorithms from the research paper
              </div>
              <button class="ai-tool-btn" onclick="extractMathematicalModels()">
                <i class="fas fa-calculator"></i>
                Extract Models & Equations
              </button>
              <div id="modelsResult" class="tool-result"></div>
            </div>
            
            <!-- Code Library Generation -->
            <div class="ai-tool-section">
              <h4><i class="fas fa-code"></i> Code Library Generation</h4>
              <div class="tool-description">
                Generate production-ready code libraries based on research concepts
              </div>
              <div class="language-selector">
                <label>Language:</label>
                <select id="libraryLanguage">
                  <option value="python">Python</option>
                  <option value="javascript">JavaScript</option>
                  <option value="java">Java</option>
                  <option value="cpp">C++</option>
                  <option value="r">R</option>
                </select>
              </div>
              <button class="ai-tool-btn" onclick="generateCodeLibrary()">
                <i class="fas fa-file-code"></i>
                Generate Library
              </button>
              <div id="libraryResult" class="tool-result"></div>
            </div>
            
            <!-- Research Tools Creation -->
            <div class="ai-tool-section">
              <h4><i class="fas fa-tools"></i> Research Tools</h4>
              <div class="tool-description">
                Create practical tools and applications from research concepts
              </div>
              <button class="ai-tool-btn" onclick="createResearchTools()">
                <i class="fas fa-wrench"></i>
                Create Tools & Apps
              </button>
              <div id="toolsResult" class="tool-result"></div>
            </div>
            
            <!-- Asset Downloads -->
            <div class="ai-tool-section">
              <h4><i class="fas fa-download"></i> Generated Assets</h4>
              <div class="asset-list" id="generatedAssets">
                <div class="asset-item">
                  <i class="fas fa-info-circle"></i>
                  <span>No assets generated yet</span>
                  <small>Use AI tools above to create assets</small>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Right Panel: Interactive Chat Session -->
          <div class="studio-right-panel">
            <div class="chat-header">
              <h3><i class="fas fa-comments"></i> AI Research Assistant</h3>
              <p>Interactive chat to understand, test, and create valuable assets</p>
            </div>
            
            <div class="chat-messages" id="chatMessages">
              <div class="message ai-message">
                <div class="message-avatar"></div>
                <div class="message-content">
                  <strong>AI Research Assistant:</strong> Welcome! I'm here to help you extract maximum value from "${selectedPaper.title}" and create practical assets.
                  <br><br>
                  <strong>What I can create for you:</strong>
                  <ul>
                    <li> <strong>Mathematical Models:</strong> Extract equations, algorithms, and formulas</li>
                    <li> <strong>Code Libraries:</strong> Generate production-ready implementations</li>
                    <li> <strong>Research Tools:</strong> Create web apps, APIs, and desktop tools</li>
                    <li> <strong>Experiments:</strong> Design tests and validation methods</li>
                    <li> <strong>Visualizations:</strong> Create data analysis tools</li>
                  </ul>
                  <br>
                  <strong>Quick Actions:</strong> Use the tools on the left or ask me anything about the research!
                </div>
              </div>
            </div>
            
            <div class="chat-input-area">
              <div class="input-group">
                <input type="text" id="chatInput" placeholder="Ask me to analyze, create, or explain something..." 
                       onkeypress="if(event.key==='Enter') sendChatMessage()">
                <button onclick="sendChatMessage()" class="send-btn">
                  <i class="fas fa-paper-plane"></i>
                </button>
              </div>
              
              <div class="quick-actions">
                <button class="quick-btn" onclick="quickAction('analyze')">
                  <i class="fas fa-search"></i> Analyze Paper
                </button>
                <button class="quick-btn" onclick="quickAction('models')">
                  <i class="fas fa-square-root-alt"></i> Extract Models
                </button>
                <button class="quick-btn" onclick="quickAction('library')">
                  <i class="fas fa-code"></i> Generate Library
                </button>
                <button class="quick-btn" onclick="quickAction('tools')">
                  <i class="fas fa-tools"></i> Create Tools
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <style>
          .research-studio {
            display: flex;
            gap: 2rem;
            height: 70vh;
            margin-top: 1rem;
          }
          
          .studio-left-panel {
            flex: 1;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1.5rem;
            overflow-y: auto;
            border: 2px solid #e9ecef;
          }
          
          .studio-right-panel {
            flex: 1;
            background: #ffffff;
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            border: 2px solid #667eea;
          }
          
          .panel-header {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #dee2e6;
          }
          
          .panel-header h3 {
            color: #667eea;
            margin-bottom: 0.5rem;
          }
          
          .paper-title {
            font-size: 0.9rem;
            color: #6c757d;
            font-style: italic;
          }
          
          .ai-tool-section {
            margin-bottom: 2rem;
            padding: 1rem;
            background: #ffffff;
            border-radius: 8px;
            border: 1px solid #dee2e6;
          }
          
          .ai-tool-section h4 {
            color: #495057;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
          }
          
          .tool-description {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 1rem;
            line-height: 1.4;
          }
          
          .ai-tool-btn {
            width: 100%;
            padding: 0.75rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
          }
          
          .ai-tool-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102,126,234,0.3);
          }
          
          .ai-tool-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
          }
          
          .language-selector {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
          }
          
          .language-selector label {
            font-weight: 600;
            color: #495057;
          }
          
          .language-selector select {
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            background: white;
          }
          
          .tool-result {
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #667eea;
            display: none;
          }
          
          .tool-result.show {
            display: block;
          }
          
          .asset-list {
            margin-top: 1rem;
          }
          
          .asset-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: #ffffff;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
          }
          
          .asset-item:hover {
            background: #f8f9fa;
            border-color: #667eea;
          }
          
          .asset-item i {
            color: #667eea;
            font-size: 1.2rem;
          }
          
          .asset-item span {
            font-weight: 600;
            color: #495057;
          }
          
          .asset-item small {
            color: #6c757d;
            font-size: 0.8rem;
          }
          
          .chat-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #dee2e6;
          }
          
          .chat-header h3 {
            color: #667eea;
            margin-bottom: 0.5rem;
          }
          
          .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 1rem;
          }
          
          .message {
            margin-bottom: 1rem;
            display: flex;
            gap: 0.75rem;
          }
          
          .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
          }
          
          .message-content {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex: 1;
          }
          
          .ai-message .message-avatar {
            background: #28a745;
          }
          
          .user-message .message-avatar {
            background: #667eea;
          }
          
          .chat-input-area {
            display: flex;
            flex-direction: column;
            gap: 1rem;
          }
          
          .input-group {
            display: flex;
            gap: 0.5rem;
          }
          
          .input-group input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.9rem;
          }
          
          .send-btn {
            padding: 0.75rem 1rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
          }
          
          .send-btn:hover {
            background: #5a6fd8;
          }
          
          .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
          }
          
          .quick-btn {
            padding: 0.5rem;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.3rem;
          }
          
          .quick-btn:hover {
            background: #e9ecef;
            border-color: #667eea;
          }
          
          @media (max-width: 1024px) {
            .research-studio {
              flex-direction: column;
              height: auto;
            }
            
            .studio-left-panel,
            .studio-right-panel {
              flex: none;
            }
          }
        </style>
      `;
    }

    // Studio Functions
    function openFile(fileType) {
      const fileName = selectedPaper.title.replace(/[^a-zA-Z0-9]/g, '_');
      let content = '';
      let fileExtension = '';
      
      switch(fileType) {
        case 'pdf':
          // Open PDF in same tab
          window.location.href = `https://arxiv.org/pdf/${selectedPaper.id}.pdf`;
          addChatMessage('user', `Opened PDF file: ${fileName}.pdf`);
          addChatMessage('ai', `I've opened the PDF version of "${selectedPaper.title}". You can now view the full research paper with all figures, tables, and detailed methodology.`);
          return;
          
        case 'html':
          // Open HTML version in same tab
          window.location.href = `https://arxiv.org/html/${selectedPaper.id}`;
          addChatMessage('user', `Opened HTML file: ${fileName}.html`);
          addChatMessage('ai', `I've opened the HTML version of the paper. This web format is easier to read and navigate, with clickable references and better formatting.`);
          return;
          
        case 'bibtex':
          content = `@article{${selectedPaper.id},
  title={${selectedPaper.title}},
  author={${selectedPaper.authors}},
  journal={arXiv preprint arXiv:${selectedPaper.id}},
  year={${new Date(selectedPaper.published).getFullYear()}},
  url={https://arxiv.org/abs/${selectedPaper.id}}
}`;
          fileExtension = 'bib';
          break;
      }
      
      if (content) {
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${fileName}.${fileExtension}`;
        a.click();
        URL.revokeObjectURL(url);
        
        addChatMessage('user', `Downloaded ${fileType.toUpperCase()} file: ${fileName}.${fileExtension}`);
        addChatMessage('ai', `I've generated and downloaded the ${fileType.toUpperCase()} file for you. You can now use this in your research workflow.`);
      }
    }

    function runApplication(appType) {
      const appNames = {
        'demo': 'Demo Application',
        'analysis': 'Content Analysis Tool',
        'visualization': 'Data Visualization Tool',
        'nlp': 'NLP Processing Tool'
      };
      
      addChatMessage('user', `Running ${appNames[appType]}`);
      
      let response = '';
      switch(appType) {
        case 'demo':
          response = ` **${appNames[appType]}** is now running!
          
This demo application demonstrates key concepts from "${selectedPaper.title}":
- **Input Processing**: Analyzing research content
- **Feature Extraction**: Identifying key methodologies
- **Output Generation**: Creating practical implementations

The app is running in the background and processing the research data. You can interact with it through the chat interface.`;
          break;
          
        case 'analysis':
          response = ` **${appNames[appType]}** is analyzing the research content...
          
**Analysis Results:**
- **Research Area**: ${elements.category.options[elements.category.selectedIndex].text}
- **Content Length**: ${selectedPaper.wordCount || 'Unknown'} words
- **Key Topics**: Machine Learning, AI, Research Methodology
- **Complexity Level**: Advanced
- **Practical Applications**: High potential for real-world use

The analysis tool has processed the paper and identified key insights and applications.`;
          break;
          
        case 'visualization':
          response = ` **${appNames[appType]}** is creating visual representations...
          
**Generated Visualizations:**
- **Research Timeline**: Publication and citation trends
- **Concept Map**: Key ideas and their relationships
- **Methodology Flow**: Research process visualization
- **Impact Metrics**: Citation and influence analysis

The visualization tool has created interactive charts and graphs to help you understand the research better.`;
          break;
          
        case 'nlp':
          response = ` **${appNames[appType]}** is processing the text content...
          
**NLP Analysis Results:**
- **Sentiment**: Academic/Technical
- **Key Entities**: Research terms, methodologies, applications
- **Topic Modeling**: Main research themes identified
- **Text Complexity**: Advanced academic level
- **Language Patterns**: Formal research writing style

The NLP processor has extracted key insights and structured the content for further analysis.`;
          break;
      }
      
      addChatMessage('ai', response);
    }

    function runResearchApp(appType) {
      const appNames = {
        'summarizer': 'Smart Summarizer',
        'recommender': 'Research Recommender',
        'generator': 'Code Generator',
        'experiment': 'Experiment Designer'
      };
      
      addChatMessage('user', `Launching ${appNames[appType]}`);
      
      let response = '';
      switch(appType) {
        case 'summarizer':
          response = ` **${appNames[appType]}** has processed the research paper:
          
**Executive Summary:**
This research paper presents innovative approaches in ${elements.category.options[elements.category.selectedIndex].text}. The study demonstrates significant improvements in methodology and practical applications.

**Key Points:**
- Novel methodology for research analysis
- Improved accuracy and efficiency
- Real-world applicability demonstrated
- Future research directions identified

**Technical Summary:**
The paper introduces advanced techniques that show promising results in experimental validation.`;
          break;
          
        case 'recommender':
          response = ` **${appNames[appType]}** has found related research:
          
**Related Papers:**
1. "Advanced AI Applications in Research" (2024)
2. "Machine Learning Methodologies" (2023)
3. "Research Automation Systems" (2024)
4. "AI-Powered Analysis Tools" (2023)

**Recommended Research Areas:**
- Extended methodology applications
- Cross-domain implementations
- Performance optimization studies
- Real-world deployment strategies

**Collaboration Opportunities:**
- Research groups working on similar topics
- Industry partnerships for practical applications
- Academic institutions with complementary expertise`;
          break;
          
        case 'generator':
          response = ` **${appNames[appType]}** has created implementation code:
          
**Generated Code Structure:**
\`\`\`python
# Research Implementation: ${selectedPaper.title}
import numpy as np
import pandas as pd
from sklearn import metrics

class ResearchImplementation:
    def __init__(self):
        self.methodology = "Advanced AI Research"
        
    def analyze_content(self, data):
        # Implementation of research methodology
        return processed_results
        
    def generate_insights(self, results):
        # Generate research insights
        return insights

# Usage example
implementation = ResearchImplementation()
results = implementation.analyze_content(your_data)
\`\`\`

**Code Features:**
- Modular architecture
- Scalable implementation
- Error handling
- Documentation included`;
          break;
          
        case 'experiment':
          response = ` **${appNames[appType]}** has designed research experiments:
          
**Experiment Design:**
1. **Hypothesis Testing**: Validate research claims
2. **Comparative Analysis**: Compare with existing methods
3. **Performance Evaluation**: Measure effectiveness
4. **Scalability Testing**: Test with larger datasets

**Experimental Setup:**
- **Dataset**: Research paper content
- **Metrics**: Accuracy, efficiency, scalability
- **Baseline**: Existing methodologies
- **Duration**: 2-4 weeks

**Expected Outcomes:**
- Validation of research methodology
- Performance benchmarks
- Practical implementation guidelines
- Future research directions`;
          break;
      }
      
      addChatMessage('ai', response);
    }

    function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (!message) return;
      
      addChatMessage('user', message);
      input.value = '';
      
      // Simulate AI response
      setTimeout(() => {
        const responses = [
          `I understand you're asking about "${message}". Based on the research paper "${selectedPaper.title}", I can help you explore this topic further. What specific aspect would you like to dive into?`,
          `Great question! The research paper addresses this through its methodology. Let me analyze the content and provide you with detailed insights about "${message}".`,
          `That's an interesting point about "${message}". The paper's findings suggest several approaches. Would you like me to generate some code or create a practical implementation?`,
          `I'm processing your request about "${message}". The research methodology in this paper could be applied to create innovative solutions. Should we design an experiment or build a prototype?`
        ];
        
        const randomResponse = responses[Math.floor(Math.random() * responses.length)];
        addChatMessage('ai', randomResponse);
      }, 1000);
    }

    function quickAction(action) {
      const actions = {
        'analyze': 'Analyze the research paper methodology and key findings',
        'code': 'Generate implementation code based on the research',
        'experiment': 'Design experiments to test the research claims',
        'app': 'Create a practical application based on the research'
      };
      
      const input = document.getElementById('chatInput');
      input.value = actions[action];
      sendChatMessage();
    }

    function addChatMessage(sender, message) {
      const chatMessages = document.getElementById('chatMessages');
      if (!chatMessages) return;
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}-message`;
      
      const avatar = sender === 'user' ? '' : '';
      const avatarBg = sender === 'user' ? '#28a745' : '#667eea';
      
      messageDiv.innerHTML = `
        <div class="message-avatar" style="background: ${avatarBg};">${avatar}</div>
        <div class="message-content">
          <strong>${sender === 'user' ? 'You' : 'AI Assistant'}:</strong> ${message}
        </div>
      `;
      
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Utility functions
    function formatDate(dateString) {
      if (!dateString) return 'Unknown date';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }

    function splitIntoSection(text) {
      if (!text) return [];
      
      const paragraphs = text.split(/\n\s*\n/).filter(p => p.trim().length > 50);
      return paragraphs.map((p, i) => ({
        title: `Section ${i + 1}`,
        content: p.trim()
      }));
    }

    function animateText(text) {
      const element = document.getElementById('animatedText');
      if (!element) return;
      
      element.innerHTML = '';
      const words = text.split(' ');
      let index = 0;
      
      function addWord() {
        if (index < words.length) {
          element.innerHTML += words[index] + ' ';
          index++;
          setTimeout(addWord, 50);
        }
      }
      
      addWord();
    }

    // Enhanced speech functions with stop functionality
    let currentSpeech = null;

    function speakText(text, buttonId = null) {
      // Stop any existing speech first
      if (currentSpeech) {
        stopSpeaking();
      }

      // Create new speech
      currentSpeech = new SpeechSynthesisUtterance(text);
      currentSpeech.rate = 0.9;
      currentSpeech.pitch = 1;
      currentSpeech.volume = 1;

      // Show stop button and hide speak button
      let speakBtn, stopBtn;
      
      if (buttonId) {
        // For specific button IDs (like in Demystification mode)
        speakBtn = document.getElementById(buttonId);
        stopBtn = document.getElementById(buttonId.replace('speak', 'stop'));
      } else {
        // Default behavior for general speak buttons
        speakBtn = document.getElementById('speakBtn');
        stopBtn = document.getElementById('stopBtn');
      }
      
      if (speakBtn) speakBtn.style.display = 'none';
      if (stopBtn) stopBtn.style.display = 'inline-block';

      // Handle speech end
      currentSpeech.onend = function() {
        currentSpeech = null;
        if (speakBtn) speakBtn.style.display = 'inline-block';
        if (stopBtn) stopBtn.style.display = 'none';
        // Stop character highlighting when speech ends
        stopCharacterHighlighting();
      };

      // Handle speech error
      currentSpeech.onerror = function() {
        currentSpeech = null;
        if (speakBtn) speakBtn.style.display = 'inline-block';
        if (stopBtn) stopBtn.style.display = 'none';
        console.error('Speech synthesis error');
        // Stop character highlighting when speech errors
        stopCharacterHighlighting();
      };

      // Start speaking
      speechSynthesis.speak(currentSpeech);
    }

    function stopSpeaking() {
      if (currentSpeech) {
        speechSynthesis.cancel();
        currentSpeech = null;
      }
      
      // Show all speak buttons and hide all stop buttons
      const speakButtons = document.querySelectorAll('[id^="speak"]');
      const stopButtons = document.querySelectorAll('[id^="stop"]');
      
      speakButtons.forEach(btn => {
        if (btn.id.startsWith('speak')) {
          btn.style.display = 'inline-block';
        }
      });
      
      stopButtons.forEach(btn => {
        if (btn.id.startsWith('stop')) {
          btn.style.display = 'none';
        }
      });
      
      // Remove all highlights when audio stops
      removeAllHighlights();
      
      // Stop character highlighting
      stopCharacterHighlighting();
    }

    function downloadPowerPoint() {
      const hasFullText = selectedPaper.fullText && selectedPaper.fullText.length > 500;
      const sections = hasFullText && selectedPaper.sections ? selectedPaper.sections : splitIntoSection(selectedPaper.summary);
      
      let content = `Title: ${selectedPaper.title}\n`;
      content += `Authors: ${selectedPaper.authors}\n`;
      content += `Published: ${formatDate(selectedPaper.published)}\n\n`;
      
      sections.forEach((section, index) => {
        content += `Slide ${index + 1}: ${section.title}\n`;
        content += `${section.content}\n\n`;
      });
      
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${selectedPaper.title.replace(/[^a-zA-Z0-9]/g, '_')}_slides.txt`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function downloadFullText() {
      const hasFullText = selectedPaper.fullText && selectedPaper.fullText.length > 500;
      const text = hasFullText ? selectedPaper.fullText : selectedPaper.summary;
      
      const content = `Title: ${selectedPaper.title}\n`;
      content += `Authors: ${selectedPaper.authors}\n`;
      content += `Published: ${formatDate(selectedPaper.published)}\n\n`;
      content += text;
      
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${selectedPaper.title.replace(/[^a-zA-Z0-9]/g, '_')}_full_text.txt`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function downloadClassroomContent() {
      const hasFullText = selectedPaper.fullText && selectedPaper.fullText.length > 500;
      const sections = hasFullText && selectedPaper.sections ? selectedPaper.sections : splitIntoSection(selectedPaper.summary);
      
      let content = `CLASSROOM CONTENT - ${selectedPaper.title}\n`;
      content += `==========================================\n\n`;
      content += `Title: ${selectedPaper.title}\n`;
      content += `Authors: ${selectedPaper.authors}\n`;
      content += `Published: ${formatDate(selectedPaper.published)}\n`;
      content += `Content Type: ${hasFullText ? 'Full Paper Content' : 'Abstract-Based Content'}\n`;
      content += `Total Sections: ${sections.length}\n`;
      content += `Word Count: ${hasFullText ? selectedPaper.wordCount : 'Abstract only'}\n\n`;
      
      content += `CLASSROOM SECTIONS:\n`;
      content += `==================\n\n`;
      
      sections.forEach((section, index) => {
        content += `SECTION ${index + 1}: ${section.title}\n`;
        content += `----------------------------------------\n`;
        content += `${section.content}\n\n`;
      });
      
      content += `\nCLASSROOM NOTES:\n`;
      content += `===============\n`;
      content += `- This content is structured for classroom presentation\n`;
      content += `- Each section can be used as a separate lesson or topic\n`;
      content += `- Content includes both titles and detailed explanations\n`;
      content += `- Suitable for educational use and research presentations\n\n`;
      
      content += `Generated by: Arxiv Research Pilot\n`;
      content += `Date: ${new Date().toLocaleDateString()}\n`;
      
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${selectedPaper.title.replace(/[^a-zA-Z0-9]/g, '_')}_classroom_content.txt`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function askAI() {
      const input = document.getElementById('aiInput');
      const question = input.value.trim();
      
      if (!question) {
        alert('Please enter a question');
        return;
      }
      
      const aiBot = document.getElementById('aiBot');
      aiBot.innerHTML = `
         AI Assistant: <em>Processing your question about "${selectedPaper.title}"...</em>
        <br><br>
        <strong>Your question:</strong> ${question}
        <br><br>
        <strong>AI Response:</strong> Based on this research paper, I can help you understand the key concepts and potential applications. The paper appears to be in the field of ${elements.category.options[elements.category.selectedIndex].text}. 
        <br><br>
        <em>Note: This is a demo response. In a full implementation, this would use advanced AI models to analyze the paper content and provide detailed insights.</em>
      `;
      
      input.value = '';
    }

    function createDemoApp() {
      const hasFullText = selectedPaper.fullText && selectedPaper.fullText.length > 500;
      
      const content = `// Demo Application Generated from: ${selectedPaper.title}
// Authors: ${selectedPaper.authors}
// Research Area: ${elements.category.options[elements.category.selectedIndex].text}

/*
This is a proof-of-concept application structure based on the research paper.
In a full implementation, this would generate actual working code.

Key Features:
- Content Analysis: ${hasFullText ? 'Full paper content available' : 'Abstract-based analysis'}
- Text Processing: Advanced NLP capabilities
- User Interface: Modern web-based interface
- Data Integration: Real-time paper processing
*/

console.log('Demo application structure generated successfully!');
console.log('This would create a working application based on the research paper.');
      `;
      
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${selectedPaper.title.replace(/[^a-zA-Z0-9]/g, '_')}_demo_app.js`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Section Selection Functions for Download Mode
    function selectAllSections() {
      const checkboxes = document.querySelectorAll('input[data-section-index]');
      checkboxes.forEach(checkbox => {
        checkbox.checked = true;
      });
      updateSectionSelection();
    }

    function deselectAllSections() {
      const checkboxes = document.querySelectorAll('input[data-section-index]');
      checkboxes.forEach(checkbox => {
        checkbox.checked = false;
      });
      updateSectionSelection();
    }

    function updateSectionSelection() {
      const checkboxes = document.querySelectorAll('input[data-section-index]');
      const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
      const totalCount = checkboxes.length;
      
      const summaryElement = document.getElementById('selectionSummary');
      if (summaryElement) {
        summaryElement.innerHTML = `<strong>Selected:</strong> ${selectedCount} of ${totalCount} sections`;
        
        // Update background color based on selection
        if (selectedCount === 0) {
          summaryElement.style.background = '#ffe6e6';
          summaryElement.style.color = '#d32f2f';
        } else if (selectedCount === totalCount) {
          summaryElement.style.background = '#e8f5e8';
          summaryElement.style.color = '#2e7d32';
        } else {
          summaryElement.style.background = '#fff3e0';
          summaryElement.style.color = '#f57c00';
        }
      }
    }

    function downloadSelectedSections() {
      const hasFullText = selectedPaper.fullText && selectedPaper.fullText.length > 500;
      const sections = hasFullText && selectedPaper.sections ? selectedPaper.sections : splitIntoSection(selectedPaper.summary);
      
      const checkboxes = document.querySelectorAll('input[data-section-index]');
      const selectedSections = [];
      
      checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
          const index = parseInt(checkbox.getAttribute('data-section-index'));
          selectedSections.push(sections[index]);
        }
      });
      
      if (selectedSections.length === 0) {
        alert('Please select at least one section to download.');
        return;
      }
      
      let content = `SELECTED SECTIONS - ${selectedPaper.title}\n`;
      content += `==========================================\n\n`;
      content += `Title: ${selectedPaper.title}\n`;
      content += `Authors: ${selectedPaper.authors}\n`;
      content += `Published: ${formatDate(selectedPaper.published)}\n`;
      content += `Content Type: ${hasFullText ? 'Full Paper Content' : 'Abstract-Based Content'}\n`;
      content += `Selected Sections: ${selectedSections.length} of ${sections.length}\n`;
      content += `Download Date: ${new Date().toLocaleDateString()}\n\n`;
      
      content += `SELECTED SECTIONS:\n`;
      content += `==================\n\n`;
      
      selectedSections.forEach((section, index) => {
        content += `SECTION ${index + 1}: ${section.title}\n`;
        content += `----------------------------------------\n`;
        content += `${section.content}\n\n`;
      });
      
      content += `\nDOWNLOAD NOTES:\n`;
      content += `===============\n`;
      content += `- This download contains only the sections you selected\n`;
      content += `- Total sections in paper: ${sections.length}\n`;
      content += `- Sections downloaded: ${selectedSections.length}\n`;
      content += `- Generated by: Arxiv Research Pilot\n`;
      
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${selectedPaper.title.replace(/[^a-zA-Z0-9]/g, '_')}_selected_sections.txt`;
      a.click();
      URL.revokeObjectURL(url);
      
      // Show success message
      addChatMessage('user', `Downloaded ${selectedSections.length} selected sections from "${selectedPaper.title}"`);
      addChatMessage('ai', `I've generated a custom download with your selected sections. The file includes ${selectedSections.length} sections out of ${sections.length} total sections from the paper.`);
    }

    function getModeDisplayName(mode) {
      const names = {
        'abstract': 'Read Abstract Mode',
        'demystify': 'Demystification Mode',
        'classroom': 'Classroom Mode',
        'deepresearch': 'Deep Research Mode',
        'download': 'Download Mode'
      };
      return names[mode] || mode;
    }

    // Demystification Mode - First Principles Analysis and Documentary-Style Explanation
    async function showDemystifyMode() {
      elements.modeContent.innerHTML = `
        <div class="section-title">
          <i class="fas fa-lightbulb"></i> Demystify Research Article - First Principles Analysis
        </div>
        <div class="section-box">
          <div style="text-align: center; padding: 2rem;">
            <div class="spinner" style="margin: 0 auto 1rem;"></div>
            <p>Breaking down complex research into simple, engaging concepts...</p>
          </div>
        </div>
      `;

      try {
        // Generate demystification content using first principles analysis
        const demystifiedContent = await generateDemystification(selectedPaper);
        
        elements.modeContent.innerHTML = `
          <div class="section-title">
            <i class="fas fa-lightbulb"></i> Demystification Mode - First Principles Analysis
          </div>
          <div class="section-box">
            <h3 style="margin-bottom: 1rem; color: #667eea;">${selectedPaper.title}</h3>
            <p style="margin-bottom: 1rem;"><strong>Authors:</strong> ${selectedPaper.authors}</p>
            <p style="margin-bottom: 1rem;"><strong>Published:</strong> ${formatDate(selectedPaper.published)}</p>
            
            <div style="margin-top: 2rem;">
              <h4 style="color: #667eea; margin-bottom: 1rem;">
                <i class="fas fa-compass"></i> The Big Picture
              </h4>
              <div id="bigPictureSection" style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; transition: all 0.3s ease;">
                <p style="font-size: 1.1rem; line-height: 1.7; margin-bottom: 0;">
                  ${demystifiedContent.bigPicture}
                </p>
              </div>
            </div>

            <div style="margin-top: 2rem;">
              <h4 style="color: #667eea; margin-bottom: 1rem;">
                <i class="fas fa-puzzle-piece"></i> Key Concepts Explained
              </h4>
              <div id="keyConceptsSection" style="display: grid; gap: 1rem; margin-bottom: 1.5rem; transition: all 0.3s ease;">
                ${demystifiedContent.concepts.map(concept => `
                  <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; border-left: 4px solid #667eea;">
                    <h5 style="color: #667eea; margin-bottom: 0.5rem;">${concept.title}</h5>
                    <p style="line-height: 1.6; margin-bottom: 0;">${concept.explanation}</p>
                  </div>
                `).join('')}
              </div>
            </div>

            <div style="margin-top: 2rem;">
              <h4 style="color: #667eea; margin-bottom: 1rem;">
                <i class="fas fa-play-circle"></i> Interactive and Immersive Documentary
              </h4>
              <div id="documentarySection" style="background: #222; color: #fff; padding: 1.5rem; border-radius: 10px; font-family: 'Georgia', serif; line-height: 1.8; transition: all 0.3s ease;">
                <p style="margin-bottom: 1rem; font-style: italic;">
                  "Imagine you're watching a fascinating documentary about cutting-edge research..."
                </p>
                <div style="line-height: 1.7;">
                  ${demystifiedContent.documentary}
                </div>
              </div>
            </div>

            <div style="margin-top: 2rem;">
              <h4 style="color: #667eea; margin-bottom: 1rem;">
                <i class="fas fa-graduation-cap"></i> Why This Matters
              </h4>
              <div id="impactSection" style="background: #e8f5e8; padding: 1.5rem; border-radius: 10px; border-left: 4px solid #28a745; transition: all 0.3s ease;">
                <p style="line-height: 1.7; margin-bottom: 0; color: #2e7d32;">
                  ${demystifiedContent.impact}
                </p>
              </div>
            </div>
          </div>
          
          <div style="display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center;">
            <button class="btn-primary" onclick="speakBigPicture()" id="speakBigPictureBtn">
              <i class="fas fa-volume-up"></i> Listen to Big Picture
            </button>
            <button class="btn-primary" onclick="stopSpeaking()" id="stopBigPictureBtn" style="display: none;">
              <i class="fas fa-stop"></i> Stop Big Picture
            </button>
            <button class="btn-primary" onclick="speakKeyConcepts()" id="speakKeyConceptsBtn">
              <i class="fas fa-volume-up"></i> Listen to Key Concepts
            </button>
            <button class="btn-primary" onclick="stopSpeaking()" id="stopKeyConceptsBtn" style="display: none;">
              <i class="fas fa-stop"></i> Stop Key Concepts
            </button>
            <button class="btn-primary" onclick="speakDocumentary()" id="speakDocumentaryBtn">
              <i class="fas fa-volume-up"></i> Listen to Documentary
            </button>
            <button class="btn-primary" onclick="stopSpeaking()" id="stopDocumentaryBtn" style="display: none;">
              <i class="fas fa-stop"></i> Stop Documentary
            </button>
            <button class="btn-primary" onclick="speakImpact()" id="speakImpactBtn">
              <i class="fas fa-volume-up"></i> Listen to Why It Matters
            </button>
            <button class="btn-primary" onclick="stopSpeaking()" id="stopImpactBtn" style="display: none;">
              <i class="fas fa-stop"></i> Stop Impact
            </button>
            <button class="btn-primary" onclick="window.location.href='${selectedPaper.pdfUrl}'">
              <i class="fas fa-file-pdf"></i> Read Full Paper
            </button>
            <button class="btn-primary" onclick="showClassroomMode()">
              <i class="fas fa-chalkboard-teacher"></i> Switch to Classroom Mode
            </button>
          </div>
        `;
        
        // Store demystification content globally for audio functions
        window.demystifiedContent = demystifiedContent;
      } catch (error) {
        console.error('Error generating demystification:', error);
        elements.modeContent.innerHTML = `
          <div class="section-title">
            <i class="fas fa-lightbulb"></i> Demystification Mode
          </div>
          <div class="section-box">
            <div style="text-align: center; padding: 2rem; color: #666;">
              <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ccc; margin-bottom: 20px;"></i>
              <h3>Demystification Unavailable</h3>
              <p>Unable to generate demystification content at this time.</p>
              <p style="font-size: 0.9rem; color: #888;">${error.message}</p>
              <button class="btn-primary" onclick="showAbstractMode()">
                <i class="fas fa-book-open"></i> Switch to Read Mode
              </button>
            </div>
          </div>
        `;
      }
    }

    // Generate demystification content using first principles analysis
    async function generateDemystification(paper) {
      // First principles analysis of the abstract
      const abstract = paper.summary;
      const title = paper.title;
      const category = paper.category;
      
      // Extract key concepts and create simplified explanations
      const concepts = extractKeyConcepts(abstract, title, category);
      
      // Generate big picture explanation
      const bigPicture = generateBigPicture(title, abstract, category);
      
      // Create documentary-style explanation
      const documentary = generateDocumentaryExplanation(title, abstract, concepts);
      
      // Explain impact and significance
      const impact = generateImpactExplanation(title, category, concepts);
      
      return {
        bigPicture,
        concepts,
        documentary,
        impact
      };
    }

    // Extract key concepts from the abstract
    function extractKeyConcepts(abstract, title, category) {
      const concepts = [];
      
      // Analyze the abstract for key terms and concepts
      const words = abstract.toLowerCase().split(/\s+/);
      const keyTerms = new Set();
      
      // Common research terms to look for
      const researchTerms = [
        'algorithm', 'model', 'method', 'approach', 'technique', 'framework',
        'neural', 'network', 'learning', 'training', 'optimization', 'performance',
        'accuracy', 'efficiency', 'scalability', 'robustness', 'generalization',
        'deep', 'machine', 'artificial', 'intelligence', 'computer', 'vision',
        'natural', 'language', 'processing', 'reinforcement', 'supervised', 'unsupervised'
      ];
      
      words.forEach(word => {
        if (researchTerms.includes(word) || word.length > 8) {
          keyTerms.add(word);
        }
      });
      
      // Create concept explanations
      const conceptMap = {
        'algorithm': 'A step-by-step procedure or recipe for solving a problem',
        'model': 'A mathematical representation that captures patterns in data',
        'neural': 'Inspired by how brain cells (neurons) work together',
        'network': 'A system of interconnected components that work together',
        'learning': 'The process of improving performance through experience',
        'deep': 'Multiple layers of processing that build complex understanding',
        'machine': 'Automated systems that can perform tasks without human intervention',
        'artificial': 'Created by humans to mimic natural intelligence',
        'intelligence': 'The ability to understand, learn, and solve problems',
        'vision': 'The ability to understand and interpret visual information',
        'language': 'Systems that can understand and generate human text',
        'processing': 'Analyzing and transforming information to extract meaning'
      };
      
      // Generate concept explanations
      Array.from(keyTerms).slice(0, 6).forEach(term => {
        if (conceptMap[term]) {
          concepts.push({
            title: term.charAt(0).toUpperCase() + term.slice(1),
            explanation: conceptMap[term]
          });
        }
      });
      
      // Add category-specific concepts
      if (category.includes('AI')) {
        concepts.push({
          title: 'Artificial Intelligence',
          explanation: 'Computer systems that can perform tasks typically requiring human intelligence'
        });
      }
      if (category.includes('CV')) {
        concepts.push({
          title: 'Computer Vision',
          explanation: 'Teaching computers to understand and interpret visual information from images or videos'
        });
      }
      if (category.includes('CL')) {
        concepts.push({
          title: 'Natural Language Processing',
          explanation: 'Helping computers understand, interpret, and generate human language'
        });
      }
      
      return concepts;
    }

    // Generate big picture explanation
    function generateBigPicture(title, abstract, category) {
      const categoryName = category.replace('cs.', 'Computer Science ').replace('cs', 'Computer Science');
      
      return `This research paper explores how we can make computers smarter and more capable in the field of ${categoryName}. 
      The researchers have developed new methods and techniques that could help solve real-world problems more effectively. 
      Think of it as creating better tools and systems that can understand, learn, and make decisions - similar to how humans do, 
      but in ways that are specifically designed for computers.`;
    }

    // Generate documentary-style explanation
    function generateDocumentaryExplanation(title, abstract, concepts) {
      const conceptNames = concepts.map(c => c.title).join(', ');
      
      return `In the world of cutting-edge technology, researchers are constantly pushing the boundaries of what's possible. 
      This particular study takes us on a journey into the fascinating realm of ${conceptNames}.
      
      The story begins with a fundamental question: How can we make computers not just faster, but smarter? 
      The researchers behind this work have discovered innovative approaches that could revolutionize how we think about technology.
      
      What makes this research special is its focus on practical applications. It's not just about theoretical concepts - 
      it's about creating real solutions that could benefit people in their everyday lives. The team has developed methods 
      that are both powerful and accessible, bridging the gap between complex science and practical use.
      
      As we dive deeper into the methodology, we discover a carefully crafted approach that combines multiple techniques 
      to achieve remarkable results. The researchers have thought through every detail, from the initial problem formulation 
      to the final implementation, ensuring that their work is both scientifically rigorous and practically useful.`;
    }

    // Generate impact explanation
    function generateImpactExplanation(title, category, concepts) {
      const categoryName = category.replace('cs.', 'Computer Science ').replace('cs', 'Computer Science');
      
      return `This research matters because it represents a step forward in making technology more intelligent and useful. 
      The methods and insights developed here could lead to better software, more efficient systems, and new capabilities 
      that we haven't even imagined yet. For students and researchers, this work opens up new possibilities for future 
      projects and discoveries. For society as a whole, it contributes to the ongoing effort to create technology that 
      truly serves human needs and enhances our capabilities.`;
    }

    // Demystification audio functions
    function speakBigPicture() {
      if (window.demystifiedContent && window.demystifiedContent.bigPicture) {
        // Scroll to and highlight the Big Picture section
        scrollToSection('bigPictureSection', '#e3f2fd');
        // Start character highlighting
        startCharacterHighlighting('bigPictureSection', window.demystifiedContent.bigPicture);
        speakText(window.demystifiedContent.bigPicture, 'speakBigPictureBtn');
      }
    }

    function speakKeyConcepts() {
      if (window.demystifiedContent && window.demystifiedContent.concepts) {
        // Scroll to and highlight the Key Concepts section
        scrollToSection('keyConceptsSection', '#667eea');
        const conceptsText = window.demystifiedContent.concepts.map(concept => 
          `${concept.title}: ${concept.explanation}`
        ).join('. ');
        // Start character highlighting
        startCharacterHighlighting('keyConceptsSection', conceptsText);
        speakText(conceptsText, 'speakKeyConceptsBtn');
      }
    }

    function speakDocumentary() {
      if (window.demystifiedContent && window.demystifiedContent.documentary) {
        // Scroll to and highlight the Documentary section
        scrollToSection('documentarySection', '#333');
        // Start character highlighting
        startCharacterHighlighting('documentarySection', window.demystifiedContent.documentary);
        speakText(window.demystifiedContent.documentary, 'speakDocumentaryBtn');
      }
    }

    function speakImpact() {
      if (window.demystifiedContent && window.demystifiedContent.impact) {
        // Scroll to and highlight the Impact section
        scrollToSection('impactSection', '#c8e6c9');
        // Start character highlighting
        startCharacterHighlighting('impactSection', window.demystifiedContent.impact);
        speakText(window.demystifiedContent.impact, 'speakImpactBtn');
      }
    }

    // Classroom Mode audio function
    function speakClassroomSection() {
      if (window.currentClassroomSection && window.currentClassroomSection.content) {
        const section = window.currentClassroomSection;
        const fullText = `Section ${section.sectionIndex + 1} of ${section.totalSections}: ${section.title}. ${section.content}`;
        
        // Start character highlighting for the animated text area
        startCharacterHighlighting('animatedText', section.content);
        
        // Use the enhanced speakText function
        speakText(fullText, 'speakClassroomBtn');
      }
    }

    // Auto-scroll and highlight function
    function scrollToSection(sectionId, highlightColor) {
      const section = document.getElementById(sectionId);
      if (section) {
        // Remove previous highlights
        removeAllHighlights();
        
        // Add highlight to current section
        section.style.boxShadow = `0 0 20px ${highlightColor}`;
        section.style.transform = 'scale(1.02)';
        section.style.border = `2px solid ${highlightColor}`;
        
        // Smooth scroll to section
        section.scrollIntoView({
          behavior: 'smooth',
          block: 'center'
        });
        
        // Remove highlight after audio ends
        setTimeout(() => {
          if (section) {
            section.style.boxShadow = '';
            section.style.transform = '';
            section.style.border = '';
          }
        }, 5000); // Remove highlight after 5 seconds
      }
    }

    // Character-by-character highlighting function
    function startCharacterHighlighting(sectionId, text) {
      const section = document.getElementById(sectionId);
      if (!section) return;
      
      // Find the text content within the section
      const textElement = section.querySelector('p') || section;
      const originalText = textElement.textContent || textElement.innerText;
      
      // Split text into words for better speech synchronization
      const words = originalText.split(/\s+/);
      let currentIndex = 0;
      
      // Calculate highlighting speed to match speech rate more accurately
      const speechRate = 0.9;
      const wordsPerMinute = 180 * speechRate; // Faster average speaking rate
      const wordsPerSecond = wordsPerMinute / 60;
      const highlightInterval = Math.max(1000 / wordsPerSecond, 20); // Milliseconds per word
      
      // Create the highlighted text structure
      const highlightedWords = words.map((word, index) => {
        const span = document.createElement('span');
        span.textContent = word + ' '; // Add space after each word
        span.style.transition = 'all 0.1s ease';
        span.style.position = 'relative';
        span.style.display = 'inline-block';
        span.dataset.index = index;
        return span;
      });
      
      // Replace the text content
      textElement.innerHTML = '';
      highlightedWords.forEach(span => textElement.appendChild(span));
      
      // Highlight words as audio progresses
      const interval = setInterval(() => {
        // Remove previous highlight
        if (currentIndex > 0) {
          const prevSpan = textElement.querySelector(`[data-index="${currentIndex - 1}"]`);
          if (prevSpan) {
            prevSpan.style.backgroundColor = '';
            prevSpan.style.color = '';
            prevSpan.style.fontWeight = '';
            prevSpan.style.borderRadius = '';
            prevSpan.style.padding = '';
            prevSpan.style.boxShadow = '';
            prevSpan.style.transform = '';
          }
        }
        
        // Add current highlight
        if (currentIndex < words.length) {
          const currentSpan = textElement.querySelector(`[data-index="${currentIndex}"]`);
          if (currentSpan) {
            currentSpan.style.backgroundColor = '#ffeb3b';
            currentSpan.style.color = '#000';
            currentSpan.style.fontWeight = 'bold';
            currentSpan.style.borderRadius = '4px';
            currentSpan.style.padding = '2px 4px';
            currentSpan.style.boxShadow = '0 0 8px rgba(255, 235, 59, 0.7)';
            currentSpan.style.transform = 'scale(1.05)';
            currentSpan.style.zIndex = '10';
            currentSpan.style.animation = 'pulse 0.3s ease-in-out';
          }
          currentIndex++;
        } else {
          // Finished highlighting
          clearInterval(interval);
          // Clean up after a delay
          setTimeout(() => {
            highlightedWords.forEach(span => {
              span.style.backgroundColor = '';
              span.style.color = '';
              span.style.fontWeight = '';
              span.style.borderRadius = '';
              span.style.padding = '';
              span.style.boxShadow = '';
              span.style.transform = '';
              span.style.animation = '';
            });
          }, 2000);
        }
      }, highlightInterval);
      
      // Store the interval for cleanup
      window.currentHighlightInterval = interval;
    }

    // Stop character highlighting
    function stopCharacterHighlighting() {
      if (window.currentHighlightInterval) {
        clearInterval(window.currentHighlightInterval);
        window.currentHighlightInterval = null;
      }
      
      // Remove all character highlights
      const highlightedSpans = document.querySelectorAll('[data-index]');
      highlightedSpans.forEach(span => {
        span.style.backgroundColor = '';
        span.style.color = '';
        span.style.fontWeight = '';
        span.style.borderRadius = '';
        span.style.padding = '';
        span.style.boxShadow = '';
        span.style.transform = '';
        span.style.animation = '';
        span.style.zIndex = '';
      });
    }

    // Remove all highlights
    function removeAllHighlights() {
      const sections = ['bigPictureSection', 'keyConceptsSection', 'documentarySection', 'impactSection'];
      sections.forEach(sectionId => {
        const section = document.getElementById(sectionId);
        if (section) {
          section.style.boxShadow = '';
          section.style.transform = '';
          section.style.border = '';
        }
      });
    }

    // ============================================================================
    // AI RESEARCH ASSISTANT FUNCTIONS
    // ============================================================================

    // Extract mathematical models from research paper
    async function extractMathematicalModels() {
      const button = event.target.closest('.ai-tool-btn');
      const resultDiv = document.getElementById('modelsResult');
      
      if (!selectedPaper) {
        showNotification('Please select a research paper first', 'error');
        return;
      }
      
      try {
        // Disable button and show loading
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Extracting Models...';
        resultDiv.innerHTML = '<div class="loading">Analyzing research paper for mathematical models...</div>';
        resultDiv.classList.add('show');
        
        // Get paper content
        const paperContent = selectedPaper.fullText || selectedPaper.abstract || '';
        
        // Call API
        const response = await fetch('/api/extract-models', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ paperContent })
        });
        
        const result = await response.json();
        
        if (result.success) {
          // Display results
          let displayContent = '';
          
          if (typeof result.models === 'string') {
            // OpenAI response
            displayContent = `
              <div class="success-message">
                <i class="fas fa-check-circle"></i> Models extracted successfully using ${result.source}
              </div>
              <div class="models-content">
                <pre>${result.models}</pre>
              </div>
              <button class="download-btn" onclick="downloadAsset('mathematical_models.txt', \`${result.models}\`)">
                <i class="fas fa-download"></i> Download Models
              </button>
            `;
          } else {
            // Local analysis response
            const models = result.models;
            displayContent = `
              <div class="success-message">
                <i class="fas fa-check-circle"></i> Models extracted using ${result.source}
              </div>
              <div class="models-content">
                <h5>Mathematical Expressions:</h5>
                <ul>
                  ${models.mathematicalExpressions.slice(0, 5).map(expr => `<li><code>${expr}</code></li>`).join('')}
                </ul>
                
                <h5>Algorithms:</h5>
                <ul>
                  ${models.algorithms.slice(0, 5).map(algo => `<li>${algo}</li>`).join('')}
                </ul>
                
                <h5>Implementation Guidelines:</h5>
                <ul>
                  ${Object.entries(models.implementation).map(([key, value]) => `<li><strong>${key}:</strong> ${value}</li>`).join('')}
                </ul>
              </div>
              <button class="download-btn" onclick="downloadAsset('mathematical_models.json', JSON.stringify(models, null, 2))">
                <i class="fas fa-download"></i> Download Models
              </button>
            `;
          }
          
          resultDiv.innerHTML = displayContent;
          
          // Add to generated assets
          addGeneratedAsset('Mathematical Models', 'mathematical_models.txt', 'Models and equations extracted from research paper');
          
        } else {
          resultDiv.innerHTML = `
            <div class="error-message">
              <i class="fas fa-exclamation-triangle"></i> Failed to extract models: ${result.error}
            </div>
          `;
        }
        
      } catch (error) {
        console.error('Model extraction error:', error);
        resultDiv.innerHTML = `
          <div class="error-message">
            <i class="fas fa-exclamation-triangle"></i> Error extracting models: ${error.message}
          </div>
        `;
      } finally {
        // Re-enable button
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-calculator"></i> Extract Models & Equations';
      }
    }

    // Generate code library from research paper
    async function generateCodeLibrary() {
      const button = event.target.closest('.ai-tool-btn');
      const resultDiv = document.getElementById('libraryResult');
      const language = document.getElementById('libraryLanguage').value;
      
      if (!selectedPaper) {
        showNotification('Please select a research paper first', 'error');
        return;
      }
      
      try {
        // Disable button and show loading
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating Library...';
        resultDiv.innerHTML = '<div class="loading">Generating code library...</div>';
        resultDiv.classList.add('show');
        
        // Get paper content
        const paperContent = selectedPaper.fullText || selectedPaper.abstract || '';
        
        // Call API
        const response = await fetch('/api/generate-library', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ paperContent, language })
        });
        
        const result = await response.json();
        
        if (result.success) {
          // Display results
          let displayContent = '';
          
          if (typeof result.library === 'string') {
            // OpenAI response
            displayContent = `
              <div class="success-message">
                <i class="fas fa-check-circle"></i> Library generated successfully using ${result.source}
              </div>
              <div class="library-content">
                <pre><code class="language-${language}">${result.library}</code></pre>
              </div>
              <button class="download-btn" onclick="downloadAsset('research_library.${getFileExtension(language)}', \`${result.library}\`)">
                <i class="fas fa-download"></i> Download Library
              </button>
            `;
          } else {
            // Local generation response
            const library = result.library;
            displayContent = `
              <div class="success-message">
                <i class="fas fa-check-circle"></i> Library generated using ${result.source}
              </div>
              <div class="library-content">
                <pre><code class="language-${language}">${library}</code></pre>
              </div>
              <div class="library-info">
                <h5>Requirements:</h5>
                <code>${result.requirements.join(', ')}</code>
                
                <h5>Documentation:</h5>
                <ul>
                  ${Object.entries(result.documentation).map(([key, value]) => `<li><strong>${key}:</strong> ${value}</li>`).join('')}
                </ul>
              </div>
              <button class="download-btn" onclick="downloadAsset('research_library.${getFileExtension(language)}', \`${library}\`)">
                <i class="fas fa-download"></i> Download Library
              </button>
            `;
          }
          
          resultDiv.innerHTML = displayContent;
          
          // Add to generated assets
          addGeneratedAsset('Code Library', `research_library.${getFileExtension(language)}`, `${language.toUpperCase()} library based on research paper`);
          
        } else {
          resultDiv.innerHTML = `
            <div class="error-message">
              <i class="fas fa-exclamation-triangle"></i> Failed to generate library: ${result.error}
            </div>
          `;
        }
        
      } catch (error) {
        console.error('Library generation error:', error);
        resultDiv.innerHTML = `
          <div class="error-message">
            <i class="fas fa-exclamation-triangle"></i> Error generating library: ${error.message}
          </div>
        `;
      } finally {
        // Re-enable button
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-file-code"></i> Generate Library';
      }
    }

    // Create research tools from research paper
    async function createResearchTools() {
      const button = event.target.closest('.ai-tool-btn');
      const resultDiv = document.getElementById('toolsResult');
      
      if (!selectedPaper) {
        showNotification('Please select a research paper first', 'error');
        return;
      }
      
      try {
        // Disable button and show loading
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Tools...';
        resultDiv.innerHTML = '<div class="loading">Creating research tools and applications...</div>';
        resultDiv.classList.add('show');
        
        // Get paper content
        const paperContent = selectedPaper.fullText || selectedPaper.abstract || '';
        
        // Call API
        const response = await fetch('/api/create-tools', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ paperContent })
        });
        
        const result = await response.json();
        
        if (result.success) {
          // Display results
          let displayContent = '';
          
          if (typeof result.tools === 'string') {
            // OpenAI response
            displayContent = `
              <div class="success-message">
                <i class="fas fa-check-circle"></i> Tools created successfully using ${result.source}
              </div>
              <div class="tools-content">
                <pre>${result.tools}</pre>
              </div>
              <button class="download-btn" onclick="downloadAsset('research_tools.md', \`${result.tools}\`)">
                <i class="fas fa-download"></i> Download Tools Specification
              </button>
            `;
          } else {
            // Local generation response
            const tools = result.tools;
            displayContent = `
              <div class="success-message">
                <i class="fas fa-check-circle"></i> Tools created using ${result.source}
              </div>
              <div class="tools-content">
                ${Object.entries(tools).map(([key, tool]) => `
                  <div class="tool-item">
                    <h5><i class="fas fa-${getToolIcon(key)}"></i> ${tool.name}</h5>
                    <p>${tool.description}</p>
                    <div class="tool-features">
                      <strong>Features:</strong>
                      <ul>
                        ${tool.features.map(feature => `<li>${feature}</li>`).join('')}
                      </ul>
                    </div>
                    <div class="tool-tech">
                      <strong>Tech Stack:</strong>
                      <code>${tool.techStack.join(', ')}</code>
                    </div>
                  </div>
                `).join('')}
              </div>
              <button class="download-btn" onclick="downloadAsset('research_tools.json', JSON.stringify(tools, null, 2))">
                <i class="fas fa-download"></i> Download Tools Specification
              </button>
            `;
          }
          
          resultDiv.innerHTML = displayContent;
          
          // Add to generated assets
          addGeneratedAsset('Research Tools', 'research_tools.json', 'Tools and applications specification');
          
        } else {
          resultDiv.innerHTML = `
            <div class="error-message">
              <i class="fas fa-exclamation-triangle"></i> Failed to create tools: ${result.error}
            </div>
          `;
        }
        
      } catch (error) {
        console.error('Tools creation error:', error);
        resultDiv.innerHTML = `
          <div class="error-message">
            <i class="fas fa-exclamation-triangle"></i> Error creating tools: ${error.message}
          </div>
        `;
      } finally {
        // Re-enable button
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-wrench"></i> Create Tools & Apps';
      }
    }

    // Helper functions
    function getFileExtension(language) {
      const extensions = {
        'python': 'py',
        'javascript': 'js',
        'java': 'java',
        'cpp': 'cpp',
        'r': 'r'
      };
      return extensions[language] || 'txt';
    }

    function getToolIcon(toolType) {
      const icons = {
        'webApplication': 'globe',
        'desktopTool': 'desktop',
        'apiService': 'server',
        'mobileApp': 'mobile-alt'
      };
      return icons[toolType] || 'tool';
    }

    function addGeneratedAsset(name, filename, description) {
      const assetsList = document.getElementById('generatedAssets');
      
      // Remove the "no assets" message if it exists
      const noAssetsItem = assetsList.querySelector('.asset-item');
      if (noAssetsItem && noAssetsItem.querySelector('span').textContent === 'No assets generated yet') {
        noAssetsItem.remove();
      }
      
      // Add new asset
      const assetItem = document.createElement('div');
      assetItem.className = 'asset-item';
      assetItem.onclick = () => downloadAsset(filename, 'Asset content');
      assetItem.innerHTML = `
        <i class="fas fa-file"></i>
        <span>${name}</span>
        <small>${description}</small>
      `;
      
      assetsList.appendChild(assetItem);
    }

    function downloadAsset(filename, content) {
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showNotification(`Downloaded ${filename}`, 'success');
    }

    // Enhanced chat functions for AI Research Assistant
    function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (!message) return;
      
      // Add user message
      addChatMessage('user', message);
      input.value = '';
      
      // Process with AI Research Assistant
      processAIResearchMessage(message);
    }

    function addChatMessage(sender, content) {
      const chatMessages = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}-message`;
      
      const avatar = sender === 'user' ? '' : '';
      const name = sender === 'user' ? 'You' : 'AI Assistant';
      
      messageDiv.innerHTML = `
        <div class="message-avatar">${avatar}</div>
        <div class="message-content">
          <strong>${name}:</strong> ${content}
        </div>
      `;
      
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function processAIResearchMessage(message) {
      // Show typing indicator
      const chatMessages = document.getElementById('chatMessages');
      const typingDiv = document.createElement('div');
      typingDiv.className = 'message ai-message typing';
      typingDiv.innerHTML = `
        <div class="message-avatar"></div>
        <div class="message-content">
          <div class="typing-indicator">
            <span></span><span></span><span></span>
          </div>
        </div>
      `;
      chatMessages.appendChild(typingDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      try {
        // Process message based on keywords
        let response = '';
        
        if (message.toLowerCase().includes('analyze') || message.toLowerCase().includes('analysis')) {
          response = await analyzeResearchPaper(message);
        } else if (message.toLowerCase().includes('model') || message.toLowerCase().includes('equation')) {
          response = await extractMathematicalModelsChat(message);
        } else if (message.toLowerCase().includes('code') || message.toLowerCase().includes('library')) {
          response = await generateCodeLibraryChat(message);
        } else if (message.toLowerCase().includes('tool') || message.toLowerCase().includes('app')) {
          response = await createResearchToolsChat(message);
        } else {
          response = await generalResearchResponse(message);
        }
        
        // Remove typing indicator and add response
        chatMessages.removeChild(typingDiv);
        addChatMessage('ai', response);
        
      } catch (error) {
        console.error('AI processing error:', error);
        chatMessages.removeChild(typingDiv);
        addChatMessage('ai', 'Sorry, I encountered an error processing your request. Please try again.');
      }
    }

    async function analyzeResearchPaper(message) {
      if (!selectedPaper) {
        return 'Please select a research paper first to analyze.';
      }
      
      const paperContent = selectedPaper.fullText || selectedPaper.abstract || '';
      
      return ` **Research Analysis for "${selectedPaper.title}"**
      
**Key Findings:**
- Research Domain: ${extractResearchDomain(paperContent)}
- Methodology: ${extractKeyConcepts(paperContent).join(', ')}
- Content Length: ${paperContent.length} characters

**Analysis:**
This research paper appears to focus on ${extractResearchDomain(paperContent).toLowerCase()} with a ${extractKeyConcepts(paperContent)[0] || 'research'} approach. The paper contains ${paperContent.length > 1000 ? 'substantial' : 'limited'} content for analysis.

**Recommendations:**
1. Extract mathematical models for implementation
2. Generate code library for practical use
3. Create research tools for broader application
4. Design experiments to validate findings

Would you like me to perform any of these specific analyses?`;
    }

    async function extractMathematicalModelsChat(message) {
      if (!selectedPaper) {
        return 'Please select a research paper first to extract mathematical models.';
      }
      
      return ` **Mathematical Model Extraction**
      
I can extract mathematical models, equations, and algorithms from the research paper. Click the "Extract Models & Equations" button in the left panel to get started.

This will:
- Identify mathematical expressions and formulas
- Extract algorithm descriptions
- Provide implementation guidelines
- Generate downloadable model files

The extracted models can be used for:
- Code implementation
- Further research
- Educational purposes
- Practical applications

Would you like me to proceed with the extraction?`;
    }

    async function generateCodeLibraryChat(message) {
      if (!selectedPaper) {
        return 'Please select a research paper first to generate a code library.';
      }
      
      return ` **Code Library Generation**
      
I can generate production-ready code libraries based on the research paper concepts. Click the "Generate Library" button in the left panel to get started.

Available languages:
- Python (recommended for research)
- JavaScript (web applications)
- Java (enterprise applications)
- C++ (high-performance computing)
- R (statistical analysis)

The generated library will include:
- Main implementation classes
- Example usage code
- Documentation
- Requirements file
- Downloadable source code

Would you like me to generate a library in your preferred language?`;
    }

    async function createResearchToolsChat(message) {
      if (!selectedPaper) {
        return 'Please select a research paper first to create research tools.';
      }
      
      return ` **Research Tools Creation**
      
I can create practical tools and applications based on the research paper concepts. Click the "Create Tools & Apps" button in the left panel to get started.

Available tool types:
- Web Applications (React.js, Node.js)
- Desktop Tools (Electron, Python)
- API Services (FastAPI, Docker)
- Mobile Apps (React Native, Firebase)

Each tool will include:
- Detailed specifications
- Feature descriptions
- Technology stack recommendations
- Implementation guidelines

Would you like me to create tools based on this research?`;
    }

    async function generalResearchResponse(message) {
      return ` **AI Research Assistant**
      
I'm here to help you extract maximum value from the research paper "${selectedPaper ? selectedPaper.title : 'your selected paper'}".

**What I can do:**
-  Analyze research methodology and findings
-  Extract mathematical models and equations
-  Generate production-ready code libraries
-  Create practical tools and applications
-  Design experiments and validation methods

**Quick Actions:**
- Use the tools in the left panel for automated asset generation
- Ask me specific questions about the research
- Request code implementations or explanations

How can I help you today?`;
    }

    // Quick action functions
    function quickAction(action) {
      const actions = {
        'analyze': 'Please analyze this research paper and explain its key findings and methodology.',
        'models': 'Extract mathematical models and equations from this research paper.',
        'library': 'Generate a Python code library based on this research paper.',
        'tools': 'Create practical tools and applications from this research paper.'
      };
      
      const message = actions[action] || 'Please help me with this research paper.';
      document.getElementById('chatInput').value = message;
      sendChatMessage();
    }

    // Helper functions for chat
    function extractResearchDomain(content) {
      if (content.match(/machine learning|ml|ai|artificial intelligence/i)) return 'AI/ML';
      if (content.match(/computer vision|cv|image/i)) return 'Computer Vision';
      if (content.match(/nlp|natural language/i)) return 'NLP';
      if (content.match(/optimization/i)) return 'Optimization';
      return 'General Research';
    }

    function extractKeyConcepts(content) {
      const concepts = [];
      const conceptPatterns = [
        /algorithm/i,
        /model/i,
        /framework/i,
        /methodology/i,
        /approach/i,
        /technique/i
      ];
      
      conceptPatterns.forEach(pattern => {
        if (content.match(pattern)) {
          concepts.push(pattern.source.replace(/[\/i]/g, ''));
        }
      });
      
      return concepts.length > 0 ? concepts : ['research', 'analysis', 'implementation'];
    }

    // Add typing indicator CSS
    const style = document.createElement('style');
    style.textContent = `
      .typing-indicator {
        display: flex;
        gap: 4px;
        align-items: center;
      }
      
      .typing-indicator span {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #667eea;
        animation: typing 1.4s infinite ease-in-out;
      }
      
      .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
      .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
      
      @keyframes typing {
        0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
      }
      
      .success-message {
        color: #28a745;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      
      .error-message {
        color: #dc3545;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      
      .loading {
        color: #667eea;
        font-style: italic;
      }
      
      .download-btn {
        margin-top: 1rem;
        padding: 0.5rem 1rem;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      
      .download-btn:hover {
        background: #218838;
      }
      
      .models-content, .library-content, .tools-content {
        max-height: 300px;
        overflow-y: auto;
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 4px;
        margin: 1rem 0;
      }
      
      .models-content pre, .library-content pre {
        white-space: pre-wrap;
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
      }
      
      .tool-item {
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: white;
        border-radius: 6px;
        border: 1px solid #dee2e6;
      }
      
      .tool-item h5 {
        color: #667eea;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      
      .tool-features ul {
        margin: 0.5rem 0;
        padding-left: 1.5rem;
      }
      
      .tool-tech code {
        background: #f8f9fa;
        padding: 0.25rem 0.5rem;
        border-radius: 3px;
        font-size: 0.85rem;
      }
      
      .library-info {
        margin-top: 1rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 4px;
      }
      
      .library-info h5 {
        color: #495057;
        margin-bottom: 0.5rem;
      }
      
      .library-info ul {
        margin: 0.5rem 0;
        padding-left: 1.5rem;
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html> 